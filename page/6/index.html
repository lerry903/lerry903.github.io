<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>LErry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="记录生活点滴">
<meta property="og:type" content="website">
<meta property="og:title" content="LErry">
<meta property="og:url" content="https://www.itchina.top/page/6/index.html">
<meta property="og:site_name" content="LErry">
<meta property="og:description" content="记录生活点滴">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LErry">
<meta name="twitter:description" content="记录生活点滴">
    

    
        <link rel="alternate" href="/" title="LErry" type="application/atom+xml" />
    

    
        <link rel="icon" href="/css/images/shortcut_icon.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">LErry</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/freebooks">书籍</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/aboutme">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/freebooks">书籍</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/aboutme">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">LErry Li</h2>
            <h3 id="title">知我者谓我心忧，不知我者谓我何求</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shanghai, China</span>
            <a id="follow" target="_blank" href="https://github.com/lerry903">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                65
                <span>文章</span>
            </div>
            <div class="article-info-block">
                54
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/lerry903" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="mailto:lerryli@foxmail.com" target="_blank" title="envelope" class=tooltip>
                            <i class="fa fa-envelope"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="qq" class=tooltip>
                            <i class="fa fa-qq"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://weibo.com/5941010376" target="_blank" title="weibo" class=tooltip>
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-apache调优隐藏版本信息及404重定向" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/apache调优隐藏版本信息及404重定向/">apache调优隐藏版本信息及404重定向</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/apache调优隐藏版本信息及404重定向/">
            <time datetime="2018-04-19T16:34:21.415Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Linux/">Linux</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Apache/">Apache</a>, <a class="tag-link" href="/tags/linux/">linux</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>apache调优隐藏版本信息及404重定向</p>
<p><strong> 本节所讲  内容：  </strong>   </p>
<p><strong> 实战：源码编译安装  apache  及调优技巧  </strong></p>
<hr>
<p><strong> 实战环境：  </strong></p>
<p><strong> 生产环境中，部署了  apache  之后，我们应该从安全还是性能角度，在  apache  服务上线之前，对其做诸多的优化调试才行。  </strong></p>
<hr>
<p><strong> Apache  </strong></p>
<p><strong> 实验环境：  </strong></p>
<p><strong> apache  版本：  httpd-2.2.31  </strong></p>
<p><strong> 源码包存放位置：  /usr/local/src  </strong></p>
<p><strong> 源码包编译安装位置：  apache  ：  /usr/local/apache2.2-xuegod/  </strong></p>
<hr>
<p><strong> 技巧  1  ：  </strong></p>
<p><strong> 安装  apache  屏蔽  apache  版本等敏感信息  </strong></p>
<hr>
<p><strong> 查看  apache  版本信息：  </strong></p>
<p><strong> [root@xuegod63 ~]# curl -I<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>  </strong></p>
<p><strong> 。。。  </strong></p>
<p><strong> X-Powered-By: HPHP  </strong></p>
<p><strong> Server:  BWS/1.1  </strong></p>
<p><strong> X-UA-Compatible:IE=Edge,chrome=1  </strong></p>
<p><strong> BDPAGETYPE: 1  </strong></p>
<p><strong> BDQID: 0xcfd31d8200026e11  </strong></p>
<p><strong> BDUSERID: 0  </strong></p>
<hr>
<p><strong> 测试自己的网站看是什么版本？有没有相应的漏洞  </strong></p>
<hr>
<p><strong> [root@xuegod63 ~]# curl -I<a href="http://www.taobao.com" target="_blank" rel="noopener">www.taobao.com</a>  </strong></p>
<p><strong> HTTP/1.1 302 Found  </strong></p>
<p><strong> Server  :Tengine  基于  nginx  做了二次开发  </strong></p>
<p><strong> Date: Tue, 17 Nov 201502:22:06 GMT  </strong></p>
<p><strong> Content-Type: text/html  </strong></p>
<p><strong> Content-Length: 258  </strong></p>
<p><strong> Connection: keep-alive  </strong></p>
<p><strong> Location: <a href="https://www.taobao.com/" target="_blank" rel="noopener"> https://www.taobao.com/ </a> </strong></p>
<p><strong> 彻底让版本等敏感信息消失  </strong></p>
<p><strong> 要彻底将版本之类的信息进行改头换面，需要在编译之前修改源码包下  include/ap_release.h  文件  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]#pwd  </strong></p>
<p><strong> /usr/local/src  </strong></p>
<p><strong> [root@xuegod63 src]# rm -rfhttpd-2.2.25  </strong></p>
<p><strong> [root@xuegod63 src]# tar zxfhttpd-2.2.25.tar.gz  </strong></p>
<p><strong> [root@xuegod63 src]# cdhttpd-2.2.25  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]#vim include/ap_release.h  #  修改源码中的版本信息为自己公司的相关信息，隐藏真实版本信息  </strong></p>
<p><strong> 改：  </strong></p>
<p><strong> 42 #define AP_SERVER_BASEVENDOR”Apache Software Foundation”  </strong></p>
<p><strong> 43 #define AP_SERVER_BASEPROJECT “ApacheHTTP Server”  </strong></p>
<p><strong> 44 #define AP_SERVER_BASEPRODUCT”Apache”  </strong></p>
<p><strong> 45  </strong></p>
<p><strong> 46 #define AP_SERVER_MAJORVERSION_NUMBER 2  </strong></p>
<p><strong> 47 #define AP_SERVER_MINORVERSION_NUMBER 2  </strong></p>
<p><strong> 48 #define AP_SERVER_PATCHLEVEL_NUMBER   25  </strong></p>
<p><strong> 49 #define AP_SERVER_DEVBUILD_BOOLEAN    0  </strong></p>
<p><strong> 为：  </strong></p>
<p><strong> #defineAP_SERVER_BASEVENDOR “xuegod”  </strong></p>
<p><strong> #defineAP_SERVER_BASEPROJECT “  </strong> <strong> web server”  </strong></p>
<p><strong> #defineAP_SERVER_BASEPRODUCT “  </strong> <strong> xuegod web server”  </strong></p>
<hr>
<p><strong> #defineAP_SERVER_MAJORVERSION_NUMBER 8  </strong></p>
<p><strong> #defineAP_SERVER_MINORVERSION_NUMBER 1  </strong></p>
<p><strong> #defineAP_SERVER_PATCHLEVEL_NUMBER   2  </strong></p>
<p><strong> #defineAP_SERVER_DEVBUILD_BOOLEAN    3  </strong></p>
<p><strong> 注释：  </strong></p>
<p><strong> #define AP_SERVER_BASEVENDOR”Apache Software Foundation” #  服务的供应商名称  </strong></p>
<p><strong> #define AP_SERVER_BASEPROJECT”Apache HTTP Server”  #  服务的项目名称  </strong></p>
<p><strong> #define AP_SERVER_BASEPRODUCT”Apache”        #  服务的产品名  </strong></p>
<p><strong> #define AP_SERVER_MAJORVERSION_NUMBER2  #  主要版本号  </strong></p>
<p><strong> #defineAP_SERVER_MINORVERSION_NUMBER 4  #  小版本号  </strong></p>
<p><strong> #defineAP_SERVER_PATCHLEVEL_NUMBER  6  #  补丁级别  </strong></p>
<p><strong> #defineAP_SERVER_DEVBUILD_BOOLEAN  0  #  </strong></p>
<p><strong> 注：上述列出的行，大家可以修改成自己想要的，然后编译安装之后，再对  httpd-default.conf  文件进行修改，对方就彻底不知道你的版本号了。  </strong></p>
<p><strong> 源码编译安装  apache  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.11]# yum installopenssl*  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]#./configure –prefix=/usr/local/apache2.2-xuegod –enable-so –enable-rewrite–enable-ssl   –enable-deflate  –enable-expires  #  检查安装环境并生成  Makefile  文件  </strong></p>
<hr>
<p><strong> 配置参数用途：  </strong></p>
<p><strong> --prefix=/usr/local/apache2.2   #  指定安装路径  </strong></p>
<p><strong> --enable-so  #  支持动态加载模  块  </strong></p>
<p><strong> --enable-rewrite #  支持网站地址重写  </strong></p>
<p><strong> --enable-ssl #  支持  ssl  加密  </strong></p>
<p><strong> --enable-deflate #  支持页面传输前进行压缩  </strong></p>
<p><strong> --enable-expires #  支持设置网页缓存的时间  </strong></p>
<hr>
<p><strong> 编译安装：  make&amp;&amp; make install  </strong></p>
<hr>
<p><strong> 查看安装后目录：  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]# ls/usr/local/apache2.2-xuegod/conf/httpd.conf  </strong></p>
<p><strong> /usr/local/apache2.2-xuegod/conf/httpd.conf  </strong></p>
<p><strong> 存放网站的根目录：  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]#ls /usr/local/apache2.2-xuegod/htdocs/  </strong></p>
<p><strong> index.html  </strong></p>
<p><strong> 修改默认首页内容：  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]# echo apache-xuegod&gt;&gt; /usr/local/apache2.2-xuegod/htdocs/index.html  </strong></p>
<p><strong> 启动  apache  ：  </strong></p>
<p><strong> 配置  apache  可以开机启动并且可以使用  service  命令启动  apache  服务器  </strong></p>
<p><strong> [root@xuegod63 httpd-2.2.25]#cp /usr/local/apache2.2-xuegod/bin/apachectl /etc/init.d/apachectl-xuegod  </strong></p>
<hr>
<p><strong> 启动  apache  ：  </strong></p>
<p><strong> [<a href="mailto:root@xuegod63httpd-2.2.25" target="_blank" rel="noopener">root@xuegod63httpd-2.2.25</a>]# /etc/init.d/apachectl-xuegod start  </strong></p>
<p><strong> 测试：  </strong></p>
<p><strong> 测试：隐藏  apache  版本信息  </strong></p>
<p><strong> [root@xuegod63 ~]# curl -I192.168.1.63   #  看不到  apache  版本相关内容了  </strong></p>
<p><strong> HTTP/1.1 200 OK  </strong></p>
<p><strong> Date: Sat, 29 Aug 201509:43:44 GMT  </strong></p>
<p><strong> Server:  xuegod web server/8.1.2-dev (Unix) mod_ssl/8.1.2-devOpenSSL/1.0.0-fips  </strong></p>
<p><strong> Last-Modified: Sat, 29 Aug2015 09:37:36 GMT  </strong></p>
<p><strong> ETag: “6d086-3a-51e6ff35dba19”  </strong></p>
<p><strong> Accept-Ranges: bytes  </strong></p>
<p><strong> Content-Length: 58  </strong></p>
<p><strong> Content-Type: text/html  </strong></p>
<hr>
<p><strong> 再次隐藏版本号和系统类型  </strong></p>
<p><strong> 接下来再次修改：  </strong></p>
<hr>
<p><strong> [root@xuegod63 ~]#  vim/usr/local/apache2.2-xuegod/conf/httpd.conf  </strong></p>
<p><strong> 405 #Includeconf/extra/httpd-default.conf  </strong></p>
<p><strong> 为：  </strong></p>
<p><strong> Includeconf/extra/httpd-default.conf  </strong></p>
<hr>
<p><strong> 2  ）打开  httpd-default.conf  文件，修改如下两个地方  </strong></p>
<p><strong> [root@xuegod63 ~]#  vim/usr/local/apache2.2-xuegod/conf/extra/httpd-default.conf  </strong></p>
<p><strong> 改：  </strong></p>
<p><strong> 55 ServerTokens Full  </strong></p>
<p><strong> 65 ServerSignature On    signature  签名  </strong></p>
<p><strong> 为：  </strong></p>
<p><strong> ServerTokens Prod   #  不显示服务器操作系统类型  </strong></p>
<p><strong> ServerSignature Off   #  不显示  web  服务器版本号  </strong></p>
<hr>
<p><strong> 让  apache  配置文件生效的方法：  </strong></p>
<p><strong> 方法  1  ：重启服务：  restart  </strong></p>
<p><strong> 方法  2  ：不重启服务，重新加载配置文件  </strong></p>
<p><strong> reload  是  nginx  </strong></p>
<p><strong> [root@xuegod63 ~]#/etc/init.d/apachectl-xuegod graceful  优雅的  </strong></p>
<p><strong> 测试：  </strong></p>
<p><strong> [root@xuegod63 ~]# curl -I192.168.1.63  </strong></p>
<p><strong> HTTP/1.1 200 OK  </strong></p>
<p><strong> Date: Thu, 14 Jan 201602:31:24 GMT  </strong></p>
<p><strong> Server:  xuegod web server  </strong></p>
<hr>
<p><strong> 总结：  </strong></p>
<p><strong> 1，  安装之前改  include/ap_release.h  </strong></p>
<p><strong> 2，  Httpd.conf    extra/httpd-default.conf  去掉注释  </strong></p>
<p><strong> 3，  修改  extra/httpd-default.conf  </strong></p>
<p><strong> 55 ServerTokens Full  </strong></p>
<p><strong> 65 ServerSignature On    signature  签名  </strong></p>
<p><strong> 为：  </strong></p>
<p><strong> ServerTokens Prod   #  不显示服务器操作系统类型  </strong></p>
<p><strong> ServerSignature Off   #  不显示  web  服务器版本号  </strong></p>
<hr>
<p><strong> 2  、错误页面优雅显示  </strong></p>
<p><strong> 为了提升网站的用户体验，避免  404  ，  403  之类的丑陋的默认错误提示出现。  </strong></p>
<p><strong> <a href="http://192.18.1.63/a.html" target="_blank" rel="noopener"> http://192.18.1.63/a.html </a> </strong></p>
<p><strong> 方法一：  </strong></p>
<p><strong> [root@xuegod63 ~]# vim/usr/local/apache2.2-xuegod/conf/httpd.conf  #  在根目录的标签中添加以下红色标记内容。  </strong></p>
<p><strong> 132 <directory" usr="" local="" apache2.2-xuegod="" htdocs"=""> </directory"></strong></p>
<p><strong> 。。。  </strong></p>
<p><strong> 在大约  159  行，插入：  </strong></p>
<p><strong> ErrorDocument 404 /404.html  </strong></p>
<p><strong> 160  </strong></p>
<p><strong> 注：  #  将  404  错误跳转到  /usr/local/apache2.2-xuegod/htdocs  下的  404.html  页面上  </strong></p>
<p><strong> 注：  ErrorDocument  的命令格式如下：  </strong></p>
<p><strong> ErrorDocument  错误代码 跳转到的页面链接或文件  </strong></p>
<hr>
<p><strong> 创建  404  测试页：  </strong></p>
<p><strong> [root@xuegod63 ~]# echo”404 go to home” &gt; /usr/local/apache2.2-xuegod/htdocs/404.html  </strong></p>
<hr>
<p><strong> 重启：  </strong></p>
<p><strong> [root@xuegod63 ~]# /etc/init.d/apachectl-xuegodrestart  </strong></p>
<hr>
<hr>
<p><strong> 方法  2  ： 出错后，跳转到一个链接  </strong></p>
<p><strong> [root@xuegod63 ~]# vim/usr/local/apache2.2-xuegod/conf/httpd.conf  #  在根目录的标签中添加以下红色标记内容。  </strong></p>
<p><strong> 132 <directory" usr="" local="" apache2.2-xuegod="" htdocs"=""> </directory"></strong></p>
<p><strong> 。。。  </strong></p>
<p><strong> 在大约  159  行，插入：  </strong></p>
<p><strong> ErrorDocument 404 <a href="http://www.baidu.com" target="_blank" rel="noopener"> http://www.baidu.com </a> </strong></p>
<p><strong> 160  </strong></p>
<p><strong> 注：  #  将  404  错误跳转到  <a href="http://www.baidu.com" target="_blank" rel="noopener"> http://www.baidu.com </a> </strong></p>
<hr>
<p><strong> 重启：  </strong></p>
<p><strong> [root@xuegod63 ~]#/etc/init.d/apachectl-xuegod restart  </strong></p>
<hr>
<hr>
<p><strong> 总结：  ErrorDocument  的命令格式如下：  </strong></p>
<p><strong> ErrorDocument  错误代码 跳转到的页面或文件  </strong></p>
<p><strong> 另外这里需要注意，你若设置跳转到文件，必须要有这个文件才行。另外文件必须在站点目录内，不然会报错。  </strong></p>
<hr>
<p><strong> 终极总结：  </strong></p>
<p><strong> 1、  隐藏  web  服务的版本信息  </strong></p>
<p><strong> 2、  出现  404  错误，给它一个友好的提示  </strong></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/apache调优隐藏版本信息及404重定向/#comments" id="sourceId::2018/04/20/apache调优隐藏版本信息及404重定向/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-Activiti工作流引擎使用" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/Activiti工作流引擎使用/">Activiti工作流引擎使用</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/Activiti工作流引擎使用/">
            <time datetime="2018-04-19T16:34:21.414Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="Activiti工作流引擎使用"><a href="#Activiti工作流引擎使用" class="headerlink" title="Activiti工作流引擎使用"></a>Activiti工作流引擎使用</h1><h1 id="1-简单介工作流引擎与Activiti"><a href="#1-简单介工作流引擎与Activiti" class="headerlink" title="1.简单介工作流引擎与Activiti"></a>1.简单介工作流引擎与Activiti</h1><p>对于工作流引擎的解释请参考百度百科： <a href="http://baike.baidu.com/view/1636259.htm" target="_blank" rel="noopener"> 工作流引擎 </a></p>
<h3 id="1-1-我与工作流引擎"><a href="#1-1-我与工作流引擎" class="headerlink" title="1.1 我与工作流引擎"></a>1.1 我与工作流引擎</h3><p>在第一家公司工作的时候主要任务就是开发OA系统，当然基本都是有工作流的支持，不过当时使用的工作流引擎是公司一些牛人开发的（据说是用一个开源的引擎修改的），名<br>称叫CoreFlow；功能相对Activiti来说比较弱，但是能满足日常的使用，当然也有不少的问题所以后来我们只能修改引擎的代码打补丁。</p>
<p>现在是我工作的第二家公司，因为要开发ERP、OA等系统需要使用工作流，在项目调研阶段我先搜索资料选择使用哪个 <strong> 开源 </strong><br>工作流引擎，最终确定了Activiti5并基于公司的架构做了一些DEMO。</p>
<h3 id="1-2-Activiti与JBPM5？"><a href="#1-2-Activiti与JBPM5？" class="headerlink" title="1.2 Activiti与JBPM5？"></a>1.2 Activiti与JBPM5？</h3><p>对于Activiti、jBPM4、jBPM5我们应该如何选择，在InfoQ上有一篇文章写的很好，从大的层面比较各个引擎之间的差异，请参考文章： <a href="http://www.infoq.com/cn/articles/rh-
jbpm5-activiti5" target="_blank" rel="noopener"><br>纵观jBPM：从jBPM3到jBPM5以及Activiti5 </a></p>
<h3 id="1-3-Activiti资料"><a href="#1-3-Activiti资料" class="headerlink" title="1.3 Activiti资料"></a>1.3 Activiti资料</h3><ul>
<li><p>官网： <a href="http://www.activiti.org/" target="_blank" rel="noopener"> http://www.activiti.org/ </a></p>
</li>
<li><p>下载： <a href="http://www.activiti.org/download.html" target="_blank" rel="noopener"> http://www.activiti.org/download.html </a></p>
</li>
<li><p>版本：Activiti的版本是从 <strong> 5 </strong> 开始的，因为Activiti是使用jBPM4的源码； <strong> 版本发布 </strong> ：两个月发布一次。 </p>
</li>
<li><p>Eclipse Plugin: <a href="http://activiti.org/designer/update/" target="_blank" rel="noopener"> http://activiti.org/designer/update/ </a></p>
</li>
<li><p>Activit中文群：5435716 </p>
</li>
</ul>
<h2 id="2-初次使用遇到问题收集"><a href="#2-初次使用遇到问题收集" class="headerlink" title="2.初次使用遇到问题收集"></a>2.初次使用遇到问题收集</h2><p>因为Activiti刚刚退出不久所以资料比较 <strong> 空缺 </strong> ，中文资料更是少的 <strong> 可怜 </strong> ，所以开始的时候一头雾水（虽然之前用过工作流，但是感觉<br>差距很多），而且官方的手册还不是很全面；所以我把我在学习使用的过程遇到的一些疑问都罗列出来分享给大家；以下几点是我遇到和想到的，如果你还有什么疑问可以在评论<br>中和我交流再补充。</p>
<h3 id="2-1-部署流程图后中文乱码"><a href="#2-1-部署流程图后中文乱码" class="headerlink" title="2.1 部署流程图后中文乱码"></a>2.1 部署流程图后中文乱码</h3><p><strong> 乱码 </strong> 是一直缠绕着国人的问题，之前各个技术、工具出现乱码的问题写过很多文章，这里也不例外……，Activiti的乱码问题在流程图中。 </p>
<p>流程图的乱码如下图所示：</p>
<p><img src="http://static.open-
open.com/lib/uploadImg/20121017/20121017155144_803.png" alt="Activiti工作流引擎使用"></p>
<p>解决办法有两种：</p>
<h4 id="2-1-1-修改源代码方式"><a href="#2-1-1-修改源代码方式" class="headerlink" title="2.1.1 修改源代码方式"></a>2.1.1 修改源代码方式</h4><p>修改源码</p>
<pre><code>org.activiti.engine.impl.bpmn.diagram.ProcessDiagramCanvas
</code></pre><p>在构造方法</p>
<pre><code>public ProcessDiagramCanvas(int width, int height)
</code></pre><p>中有一行代码是设置字体的，默认是用  <strong> Arial </strong> 字体，这就是乱码产生的原因，把字改为本地的中文字体即可，例如：</p>
<pre><code>Font font = new Font(&quot;WenQuanYi Micro Hei&quot;, Font.BOLD, 11);
</code></pre><p>当然如果你有配置文件读取工具那么可以设置在*.properties文件中，我就是这么做的：</p>
<pre><code>Font font = new Font(PropertyFileUtil.get(&quot;activiti.diagram.canvas.font&quot;), Font.BOLD, 11);
</code></pre><h4 id="2-1-2-使用压缩包方式部署"><a href="#2-1-2-使用压缩包方式部署" class="headerlink" title="2.1.2 使用压缩包方式部署"></a>2.1.2 使用压缩包方式部署</h4><p>Activiti支持部署*.bpmn20.xml、bar、zip格式的流程定义。</p>
<p>使用Activit Deisigner工具设计流程图的时候会有三个类型的文件:</p>
<ul>
<li><p>.activiti设计工具使用的文件 </p>
</li>
<li><p>.bpmn20.xml设计工具自动根据.activiti文件生成的xml文件 </p>
</li>
<li><p>.png流程图图片 </p>
</li>
</ul>
<p>解决办法就是把xml文件和图片文件同时部署，因为在单独部署xml文件的时候Activiti会自动生成一张流程图的图片文件，但是这样在使用的时候坐标和图片对应<br>不起来……</p>
<p>所以把xml和图片同时部署的时候Activiti自动关联xml和图片，当需要获取图片的时候直接返回部署时压缩包里面的图片文件，而不是Activiti自动生成<br>的图片文件</p>
<h5 id="2-1-2-1-使用工具打包Bar文件"><a href="#2-1-2-1-使用工具打包Bar文件" class="headerlink" title="2.1.2.1 使用工具打包Bar文件"></a>2.1.2.1 使用工具打包Bar文件</h5><p>右键项目名称然后点击“Create deployment artifacts”，会在src目录中创建 <strong> deployment </strong><br>文件夹，里面包含*.bar文件.</p>
<h5 id="2-1-2-2-使用Ant脚本打包Zip文件"><a href="#2-1-2-2-使用Ant脚本打包Zip文件" class="headerlink" title="2.1.2.2 使用Ant脚本打包Zip文件"></a>2.1.2.2 使用Ant脚本打包Zip文件</h5><p>这也是我们采用的办法，你可以手动选择xml和png打包成zip格式的文件，也可以像我们一样采用ant target的方式打包这两个文件。</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project name=&quot;foo&quot;&gt;

    &lt;property name=&quot;workflow.definition&quot; value=&quot;foo-common-core/src/main/resources/diagrams&quot; /&gt;
    &lt;property name=&quot;workflow.deployments&quot; value=&quot;foo-common-core/src/main/resources/deployments&quot; /&gt;

&lt;target name=&quot;workflow.package.oa.leave&quot;&gt;
        &lt;echo&gt;打包流程定义及流程图::OA-请假&lt;/echo&gt;
        &lt;zip destfile=&quot;${workflow.deployments}/oa/leave.zip&quot; basedir=&quot;${workflow.definition}/oa/leave&quot; update=&quot;true&quot;
            includes=&quot;*.xml,*.png&quot; /&gt;
    &lt;/target&gt;
&lt;/project&gt;
</code></pre><p>这样当修改流程定义文件后只要运行ant命令就可以打包了：</p>
<pre><code>ant workflow.package.oa.leave
</code></pre><p>现在部署bar或者zip文件查看流程图图片就不是乱码了，而是你的压缩包里面的png文件。</p>
<h3 id="2-2-使用引擎提供的Form还是自定义业务Form"><a href="#2-2-使用引擎提供的Form还是自定义业务Form" class="headerlink" title="2.2 使用引擎提供的Form还是自定义业务Form"></a>2.2 使用引擎提供的Form还是自定义业务Form</h3><h4 id="2-2-1-引擎提供的Form"><a href="#2-2-1-引擎提供的Form" class="headerlink" title="2.2.1 引擎提供的Form"></a>2.2.1 引擎提供的Form</h4><p>定义表单的方式在每个Task标签中定义 <strong> extensionElements </strong> 和 <strong> activiti:formProperty </strong><br>即可，到达这个节点的时候可以通过API读取表单元素。</p>
<p>Activiti官方的例子使用的就是在流程定义中设置每一个节点显示什么样的表单哪些字段需要显示、哪些字段只读、哪些字段必填。</p>
<p>但是这种方式仅仅适用于比较简单的流程，对于稍微复杂或者页面需要业务逻辑的判断的情况就不适用了。</p>
<p>对于数据的保存都是在引擎的表中，不利于和其他表的关联、对整个系统的规划也不利！</p>
<h4 id="2-2-2-自定义业务Form"><a href="#2-2-2-自定义业务Form" class="headerlink" title="2.2.2 自定义业务Form"></a>2.2.2 自定义业务Form</h4><p>这种方式应该是大家用的最多的了，因为一般的业务系统业务逻辑都会比较复杂，而且数据库中很多表都会有依赖关系，表单中有很多状态判断。</p>
<p>例如我们的系统适用jQuery UI作为UI，有很多javascript代码，页面的很多操作需要特殊处理（例如：多个选项的互斥、每个节点根据类型和操作人显示<br>不同的按钮）；基本每个公司都有一套自己的UI风格，要保持多个系统的操作习惯一致只能使用自定义表单才能满足。</p>
<h3 id="2-3-业务和流程的关联方式"><a href="#2-3-业务和流程的关联方式" class="headerlink" title="2.3 业务和流程的关联方式"></a>2.3 业务和流程的关联方式</h3><p>这个问题在群里面很多人都问过，这也是我刚刚开始迷惑的地方；</p>
<p>后来看了以下API发现RuntimeService有两个方法：</p>
<h3 id="2-3-1-startProcessInstanceByKey"><a href="#2-3-1-startProcessInstanceByKey" class="headerlink" title="2.3.1 startProcessInstanceByKey"></a>2.3.1 startProcessInstanceByKey</h3><p>javadoc对其说明：</p>
<pre><code>startProcessInstanceByKey(String processDefinitionKey, Map variabes) 
          Starts a new process instance in the latest version of the process definition with the given key
</code></pre><p>其中 <strong> businessKey </strong><br>就是业务ID，例如要申请请假，那么先填写登记信息，然后（保存+启动流程），因为请假是单独设计的数据表，所以保存后得到实体ID就可以把它传给 <strong><br>processInstanceBusinessKey </strong> 方法启动流程。当需要根据businessKey查询流程的时候就可以通过API查询:</p>
<pre><code>runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(processInstanceBusinessKey, processDefinitionKey);
</code></pre><p>建  <strong> 议数据库冗余设计 </strong> ：在业务表设计的时候添加一列：  <strong> PROCESS_INSTANCE_ID varchar2(64) </strong><br>，在流程启动之后把流程ID更新到业务表中，这样不管从业务还是流程都可以查询到对方！</p>
<p><strong> 特别说明： </strong> 此方法启动时自动选择最新版本的流程定义。 </p>
<h3 id="2-3-2-startProcessInstanceById"><a href="#2-3-2-startProcessInstanceById" class="headerlink" title="2.3.2 startProcessInstanceById"></a>2.3.2 startProcessInstanceById</h3><p>javadoc对其说明：</p>
<pre><code>startProcessInstanceById(String processDefinitionId, String businessKey, Map variables) 
          Starts a new process instance in the exactly specified version of the process definition with the given id.
</code></pre><p><strong> processDefinitionId </strong> ：这个参数的值可以通过 <strong> repositoryService.createProcessDefinitionQuery() </strong> 方法查询，对应数据库： <strong> ACT_RE_PROCDEF </strong> ；每次部署一次流程定义就会添加一条数据，同名的版本号累加。 </p>
<p><strong> 特别说明： </strong> 此可以指定不同版本的流程定义，让用户多一层选择。 </p>
<h3 id="2-3-3-如何选择"><a href="#2-3-3-如何选择" class="headerlink" title="2.3.3 如何选择"></a>2.3.3 如何选择</h3><p>建议使用 <strong> startProcessInstanceByKey </strong> ，特殊情况需要使用以往的版本选择使用 <strong><br>startProcessInstanceById </strong> 。</p>
<h3 id="2-4-同步用户数据"><a href="#2-4-同步用户数据" class="headerlink" title="2.4 同步用户数据"></a>2.4 同步用户数据</h3><p>这个问题也是比较多的人询问过，Activiti支持对任务分配到：指定人、指定组、两者组合，而这些人和组的信息都保存在 <strong> ACT_ID.. </strong> 表中，有<br>自己的用户和组(角色)管理让很多人不知所措了；原因是因为每个系统都会存在一个权限管理模块（维护：用户、部门、角色、授权），不知道该怎么和Activiti同步<br>。</p>
<h4 id="2-4-1-建议处理方式"><a href="#2-4-1-建议处理方式" class="headerlink" title="2.4.1 建议处理方式"></a>2.4.1 建议处理方式</h4><p>Activiti有一个 <strong> IdentityService </strong> 接口，通过这个接口可以操控Activiti的ACT_ID_*表的数据，一般的做法是用业务<br>系统的权限管理模块维护用户数据，当进行CRUD操作的时候在原有业务逻辑后面添加同步到Activiti的代码；例如添加一个用户时同步Activiti<br>User的代码片段：</p>
<pre><code>/**
 * 保存用户信息 并且同步用户信息到activiti的identity.User，同时设置角色
 * @param user
 * @param roleIds
 */
public void saveUser(User user, List&lt;Long&gt; roleIds, boolean synToActiviti) {
    accountManager.saveEntity(user);
    String userId = user.getId().toString();

    if (synToActiviti) {
        List&lt;org.activiti.engine.identity.User&gt; activitiUsers = identityService.createUserQuery().userId(userId).list();
        if (activitiUsers.size() == 1) {
            //更新信息
            org.activiti.engine.identity.User activitiUser = activitiUsers.get(0);
            activitiUser.setFirstName(user.getName());
            activitiUser.setLastName(&quot;&quot;);
            activitiUser.setPassword(user.getPassword());
            activitiUser.setEmail(user.getEmail());
            identityService.saveUser(activitiUser);

            // 删除用户的membership
            List&lt;Group&gt; activitiGroups = identityService.createGroupQuery().groupMember(userId).list();
            for (Group group : activitiGroups) {
                identityService.deleteMembership(userId, group.getId());
            }

            // 添加membership
            for (Long roleId : roleIds) {
                Role role = roleManager.getEntity(roleId);
                identityService.createMembership(userId, role.getEnName());
            }

        } else {
            org.activiti.engine.identity.User newUser = identityService.newUser(userId);
            newUser.setFirstName(user.getName());
            newUser.setLastName(&quot;&quot;);
            newUser.setPassword(user.getPassword());
            newUser.setEmail(user.getEmail());
            identityService.saveUser(newUser);

            // 添加membership
            for (Long roleId : roleIds) {
                Role role = roleManager.getEntity(roleId);
                identityService.createMembership(userId, role.getEnName());
            }
        }
    }

}
</code></pre><p>删除操作也和这个类似！</p>
<p>不管从业务系统维护用户还是从Activiti维护，肯定要确定一方，然后CRUD的时候同步到对方，如果需要同步多个子系统那么可以再调用WebService实现<br>。</p>
<h3 id="2-5-流程图设计工具用什么"><a href="#2-5-流程图设计工具用什么" class="headerlink" title="2.5 流程图设计工具用什么"></a>2.5 流程图设计工具用什么</h3><p>Activiti提供了两个流程设计工具，但是面向对象不同。</p>
<ul>
<li><p>Activiti Modeler，面向业务人员，使用开源的BPMN设计工具 <a href="http://www.signavio.com/en.html" target="_blank" rel="noopener"> Signavio </a> ，使用BPMN描述业务流程图 </p>
</li>
<li><p>Eclipse Designer，面向开发人员，Eclipse的插件，可以让开发人员定制每个节点的属性（ID、Name、Listener、Attr等） </p>
</li>
</ul>
<h4 id="2-5-1-我们的方式"><a href="#2-5-1-我们的方式" class="headerlink" title="2.5.1 我们的方式"></a>2.5.1 我们的方式</h4><p>可能你会惊讶，因为我们没有使用Activiti Modeler，我们认为用Viso已经能表达流程图的意思了，而且项目经理也是技术出身，和开发人员也容易沟通。</p>
<p>目前这个项目是第一个使用Activiti的，开始我们在需求调研阶段使用Viso设计流程图，利用 <a href="http://wiki.mbalib.com/wiki/%E6%B3%B3%E9%81%93%E6%B5%81%E7%A8%8B%E5%9B%BE" target="_blank" rel="noopener"> 泳道流程图
</a><br>设计和客户沟通，确定后由负责流程的开发人员用Eclipse Designer设计得到bpmn20.xml，最后部署。</p>
<h3 id="2-6-Eclipse-Designer存在的问题"><a href="#2-6-Eclipse-Designer存在的问题" class="headerlink" title="2.6 Eclipse Designer存在的问题"></a>2.6 Eclipse Designer存在的问题</h3><p>这个插件有一个很讨厌的Bug一直未修复，安装了插件后Eclipse的复制和粘帖快捷键会被更换为(Ctrl+Insert、Shift+Insert)；Bug描<br>述请见：</p>
<ul>
<li><p><a href="http://forums.activiti.org/en/viewtopic.php?f=8&amp;t=2701" target="_blank" rel="noopener"> Activit Forums中报告的Bug </a></p>
</li>
<li><p><a href="http://jira.codehaus.org/browse/ACT-992" target="_blank" rel="noopener"> Jira的登记 </a></p>
</li>
</ul>
<p>所以最后我们只能单独开一个安装了Eclipse Designer的Eclipse专门用来设计流程图，这样就不影响正常使用Eclipse JAVAEE了。</p>
<h2 id="3-配置"><a href="#3-配置" class="headerlink" title="3.配置"></a>3.配置</h2><h3 id="3-1-集成Spring"><a href="#3-1-集成Spring" class="headerlink" title="3.1 集成Spring"></a>3.1 集成Spring</h3><p>对于和Spring的集成Activiti做的不错，简单配置一些Bean代理即可实现，但是有两个和事务相关的地方要提示：</p>
<ul>
<li><p>配置 <strong> processEngineConfiguration </strong> 的时候属性 <strong> transactionManager </strong> 要使用和业务功能的同一个事务管理Bean，否则事务不同步。 </p>
</li>
<li><p>对于实现了org.activiti.engine.delegate包中的接口的类需要被事务控制的实现类需要被Spring代理，并且添加事务的Annotation或者在xml中配置，例如: </p>
</li>
</ul>
<pre><code>/**
 * 创建缴费流程的时候自动创建实体
 *
 * @author HenryYan
 */
@Service
@Transactional
publicclass CreatePaymentProcessListener implementsExecutionListener {
   ....
}
</code></pre><h2 id="4-使用单元测试"><a href="#4-使用单元测试" class="headerlink" title="4.使用单元测试"></a>4.使用单元测试</h2><p>单元测试均使用Spring的AbstractTransactionalJUnit4SpringContextTests作为SuperClass，并且在测试类<br>添加：</p>
<pre><code>@ContextConfiguration(locations = { &quot;/applicationContext-test.xml&quot;})
@RunWith(SpringJUnit4ClassRunner.class)
</code></pre><p>虽然Activiti也提供了测试的一些超类，但是感觉不好用，所以自己封装了一些方法。</p>
<p>代码请转移： <a href="https://gist.github.com/2182847" target="_blank" rel="noopener"> https://gist.github.com/2182847 </a></p>
<h3 id="4-1-验证流程图设计是否正确"><a href="#4-1-验证流程图设计是否正确" class="headerlink" title="4.1 验证流程图设计是否正确"></a>4.1 验证流程图设计是否正确</h3><p>代码请转移： <a href="https://gist.github.com/2182869" target="_blank" rel="noopener"> https://gist.github.com/2182869 </a></p>
<h3 id="4-2-业务对象和流程关联测试"><a href="#4-2-业务对象和流程关联测试" class="headerlink" title="4.2 业务对象和流程关联测试"></a>4.2 业务对象和流程关联测试</h3><p>代码请转移： <a href="https://gist.github.com/2182973" target="_blank" rel="noopener"> https://gist.github.com/2182973 </a></p>
<h2 id="5-各种状态的任务查询以及和业务对象关联"><a href="#5-各种状态的任务查询以及和业务对象关联" class="headerlink" title="5.各种状态的任务查询以及和业务对象关联"></a>5.各种状态的任务查询以及和业务对象关联</h2><p>我们目前分为4中状态：未签收、办理中、运行中、已完成。</p>
<p>查询到任务或者流程实例后要显示在页面，这个时候需要添加业务数据，最终结果就是业务和流程的并集，请参考 <strong> 6.2 </strong> 。</p>
<h3 id="5-1-未签收-Task"><a href="#5-1-未签收-Task" class="headerlink" title="5.1 未签收(Task)"></a>5.1 未签收(Task)</h3><p>此类任务针对于把Task分配给一个角色时，例如部门领导，因为 <strong> 部门领导 </strong> 角色可以指定多个人所以需要先签收再办理，术语： <strong> 抢占式 </strong></p>
<p>对应的API查询：</p>
<pre><code>/**
 * 获取未签收的任务查询对象
 * @param userId    用户ID
 */
@Transactional(readOnly = true)
publicTaskQuery createUnsignedTaskQuery(String userId) {
    TaskQuery taskCandidateUserQuery = taskService.createTaskQuery().processDefinitionKey(getProcessDefKey())
            .taskCandidateUser(userId);
    returntaskCandidateUserQuery;
}
</code></pre><h3 id="5-2-办理中-Task"><a href="#5-2-办理中-Task" class="headerlink" title="5.2 办理中(Task)"></a>5.2 办理中(Task)</h3><p>此类任务数据类源有两种:</p>
<ul>
<li><p>签收后的，5.1中签收后就应该为办理中状态 </p>
</li>
<li><p>节点指定的是具体到一个人，而不是角色 </p>
</li>
</ul>
<p>对应的API查询：</p>
<pre><code>/**
 * 获取正在处理的任务查询对象
 * @param userId    用户ID
 */
@Transactional(readOnly = true)
publicTaskQuery createTodoTaskQuery(String userId) {
    TaskQuery taskAssigneeQuery = taskService.createTaskQuery().processDefinitionKey(getProcessDefKey()).taskAssignee(userId);
    returntaskAssigneeQuery;
}
</code></pre><h3 id="5-3-运行中-ProcessInstance"><a href="#5-3-运行中-ProcessInstance" class="headerlink" title="5.3 运行中(ProcessInstance)"></a>5.3 运行中(ProcessInstance)</h3><p>说白了就是没有结束的流程，所有参与过的人都应该可以看到这个实例，但是Activiti的API没有可以通过用户查询的方法，这个只能自己用hack的方式处理了，<br>我目前还没有处理。</p>
<p>从表 <strong> ACT_RU_EXECUTION </strong> 中查询数据。</p>
<p>对应的API查询：</p>
<pre><code>/**
 * 获取未经完成的流程实例查询对象
 * @param userId    用户ID
 */
@Transactional(readOnly = true)
publicProcessInstanceQuery createUnFinishedProcessInstanceQuery(String userId) {
    ProcessInstanceQuery unfinishedQuery = runtimeService.createProcessInstanceQuery().processDefinitionKey(getProcessDefKey())
            .active();
    returnunfinishedQuery;
}
</code></pre><h3 id="5-4-已完成-HistoricProcessInstance"><a href="#5-4-已完成-HistoricProcessInstance" class="headerlink" title="5.4 已完成(HistoricProcessInstance)"></a>5.4 已完成(HistoricProcessInstance)</h3><p>已经结束的流程实例。</p>
<p>从表 <strong> ACT_HI_PROCINST </strong> 中查询数据。</p>
<pre><code>/**
 * 获取已经完成的流程实例查询对象
 * @param userId    用户ID
 */
@Transactional(readOnly = true)
publicHistoricProcessInstanceQuery createFinishedProcessInstanceQuery(String userId) {
    HistoricProcessInstanceQuery finishedQuery = historyService.createHistoricProcessInstanceQuery()
            .processDefinitionKey(getProcessDefKey()).finished();
    returnfinishedQuery;
}
</code></pre><h3 id="5-5-查询时和业务关联"><a href="#5-5-查询时和业务关联" class="headerlink" title="5.5 查询时和业务关联"></a>5.5 查询时和业务关联</h3><p>提示：之前在业务对象添加了 <strong> PROCESS_INSTANCE_ID </strong> 字段</p>
<p>思路：现在可以利用这个字段查询了，不管是Task还是ProcessInstance都可以得到流程实例ID，可以根据流程实例ID查询实体然后把流程对象设置到实<br>体的一个属性中由Action或者Controller输出到前台。</p>
<p>代码请参考： <a href="https://gist.github.com/2183557" target="_blank" rel="noopener"> https://gist.github.com/2183557 </a></p>
<h2 id="6-UI及截图"><a href="#6-UI及截图" class="headerlink" title="6.UI及截图"></a>6.UI及截图</h2><p>结合实际业务描述一个业务从开始到结束的过程，对于迷惑的同学看完豁然开朗了；这里使用请假作为例子。</p>
<h3 id="6-1-单独一个列表负责申请"><a href="#6-1-单独一个列表负责申请" class="headerlink" title="6.1 单独一个列表负责申请"></a>6.1 单独一个列表负责申请</h3><p>这样的好处是申请和流程办理分离开处理，列表显示未启动流程的请假记录（数据库PROCESS_INSTANCE_ID为空）。</p>
<p>申请界面的截图：</p>
<p><img src="http://static.open-
open.com/lib/uploadImg/20121017/20121017155145_849.png" alt="Activiti工作流引擎使用"></p>
<h3 id="6-2-流程状态"><a href="#6-2-流程状态" class="headerlink" title="6.2 流程状态"></a>6.2 流程状态</h3><p><img src="http://static.open-
open.com/lib/uploadImg/20121017/20121017155146_668.png" alt="Activiti工作流引擎使用"></p>
<h3 id="6-3-流程跟踪"><a href="#6-3-流程跟踪" class="headerlink" title="6.3 流程跟踪"></a>6.3 流程跟踪</h3><p>图片方式显示当前节点：</p>
<p><img src="http://static.open-
open.com/lib/uploadImg/20121017/20121017155147_20.png" alt="Activiti工作流引擎使用"></p>
<p>列表形式显示流程流转过程:</p>
<p><img src="http://static.open-
open.com/lib/uploadImg/20121017/20121017155147_321.png" alt="Activiti工作流引擎使用"></p>
<h4 id="6-3-1-当前节点定位JS"><a href="#6-3-1-当前节点定位JS" class="headerlink" title="6.3.1 当前节点定位JS"></a>6.3.1 当前节点定位JS</h4><p><strong> Java </strong> 代码请移步： <a href="https://gist.github.com/2183712" target="_blank" rel="noopener"> https://gist.github.com/2183712 </a></p>
<p><strong> Javascript </strong> 思路：先通过Ajax获取当前节点的坐标，在指定位置添加红色边框，然后加载图片。 </p>
<p>代码移步： <a href="https://gist.github.com/2183804" target="_blank" rel="noopener"> https://gist.github.com/2183804 </a></p>
<h2 id="7-开启Logger"><a href="#7-开启Logger" class="headerlink" title="7.开启Logger"></a>7.开启Logger</h2><ol>
<li>添加log4j的jar </li>
<li>设置 <strong> log4j.logger.java.sql </strong> =DEBUG </li>
</ol>
<h2 id="8-结束"><a href="#8-结束" class="headerlink" title="8.结束"></a>8.结束</h2><p>之前就想写这篇文章，现在终于完成了，花费了几个小时，希望能节省你几天的时间。</p>
<p>请读者仔细阅读Activiti的用户手册和Javadoc。  </p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/Activiti工作流引擎使用/#comments" id="sourceId::2018/04/20/Activiti工作流引擎使用/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(7)：如何清理无效的延时消息？" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(7)：如何清理无效的延时消息？/">ActiveMQ笔记(7)：如何清理无效的延时消息？</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(7)：如何清理无效的延时消息？/">
            <time datetime="2018-04-19T16:34:21.413Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>ActiveMQ的延时消息是一个让人又爱又恨的功能，具体使用可参考上篇 <a href="http://blog.csdn.net/lsy0903/article/details/56672475" target="_blank" rel="noopener"> ActiveMQ笔记(6)：消息延时投递
</a> ，在很多需要消息延时投递的业务场景十分有用<br>，但是也有一个缺陷，在一些大访问量的场景，如果瞬间向MQ发送海量的延时消息，超过MQ的调度能力，就会造成很多消息到了该投递的时刻，却没有投递出去，形成积压，<br>一直停留在ActiveMQ web控制台的Scheduled面板中。</p>
<p>下面的代码演示了，如何清理activemq中的延时消息（包括：全部清空及清空指定时间段的延时消息），这也是目前唯一可行的办法。</p>
<p>为了演示方便，先封装一个小工具类：</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p>34</p>
<p>35</p>
<p>36</p>
<p>37</p>
<p>38</p>
<p>39</p>
<p>40</p>
<p>41</p>
<p>42</p>
<p>43</p>
<p>44</p>
<p>45</p>
<p>46</p>
<p>47</p>
<p>48</p>
<p>49</p>
<p>50</p>
<p>51</p>
<p>52</p>
<p>53</p>
<p>54</p>
<p>55</p>
<p>56</p>
<p>57</p>
<p>58</p>
<p>59</p>
<p>60</p>
<p>61</p>
<p>62</p>
<p>63</p>
<p>64</p>
<p>65</p>
<p>66</p>
<p>67</p>
<p>68</p>
<p>69</p>
<p>70</p>
<p>71</p>
<p>72</p>
<p>73</p>
<p>74</p>
<p>75</p>
<p>76</p>
<p>77</p>
<p>78</p>
<p>79</p>
<p>80</p>
<p>81</p>
<p>82</p>
<p>83</p>
<p>84</p>
<p>85</p>
<p>86</p>
<p>87</p>
<p>88</p>
<p>89</p>
<p>90</p>
<p>91</p>
<p>92</p>
<p>93</p>
<p>94</p>
<p>95</p>
<p>96</p>
<p>97</p>
<p>98</p>
<p>99</p>
<p>100</p>
<p>101</p>
<p>102</p>
<p>103</p>
<p>104</p>
<p>105</p>
<p>106</p>
<p>107</p>
<p>108</p>
<p>109</p>
<p>110</p>
<p>111</p>
<p>112</p>
<p>113</p>
<p>114</p>
<p>115</p>
<p>116</p>
<p>117</p>
<p>118</p>
<p>119</p>
<p>120</p>
<p>121</p>
<p><code>package</code> <code>cn.mwee.utils.mq;</code></p>
<p><code>import</code> <code>cn.mwee.utils.list.ListUtil;</code></p>
<p><code>import</code> <code>cn.mwee.utils.log4j2.MwLogger;</code></p>
<p><code>import</code> <code>org.apache.commons.lang.StringUtils;</code></p>
<p><code>import</code> <code>org.slf4j.Logger;</code></p>
<p><code>import</code> <code>org.springframework.jms.core.JmsTemplate;</code></p>
<p><code>import</code> <code>org.springframework.jms.core.MessagePostProcessor;</code></p>
<p><code>import</code> <code>javax.jms.ConnectionFactory;</code></p>
<p><code>import</code> <code>javax.jms.JMSException;</code></p>
<p><code>import</code> <code>javax.jms.TextMessage;</code></p>
<p><code>import</code> <code>java.util.ArrayList;</code></p>
<p><code>import</code> <code>java.util.List;</code></p>
<p><code>import</code> <code>java.util.stream.Collectors;</code></p>
<p><code>/**</code></p>
<p><code></code> <code>* Created by yangjunming on 6/20/16.</code></p>
<p><code></code> <code>*/</code></p>
<p><code>public</code> <code>final</code> <code>class</code> <code>MessageUtil {</code></p>
<p><code></code> <code>private</code> <code>Logger logger =</code> <code>new</code> <code>MwLogger(MessageUtil.</code> <code>class</code> <code>);</code> <code>//这里就是一个Log4j2的实例,大家可以换成原生的log4j2或类似工具</code></p>
<p><code></code> <code>private</code> <code>ConnectionFactory connectionFactory;</code></p>
<p><code></code> <code>private</code> <code>long</code> <code>receiveTimeout;</code> <code>//接收超时时间</code></p>
<p><code></code> <code>private</code> <code>JmsTemplate jmsTemplate;</code></p>
<p><code></code> <code>private</code> <code>List&lt;String&gt; destinationQueueNames;</code></p>
<p><code></code> <code>private</code> <code>final</code> <code>static</code> <code>String BACKUP_QUEUE_SUFFIX =</code> <code>&quot;_B&quot;</code><br><code>;</code></p>
<p><code></code> <code>private</code> <code>boolean</code> <code>autoBackup =</code> <code>false</code> <code>;</code> <code>//是否自动将消息备份到_b的队列，方便调试</code></p>
<p><code></code> <code>public</code> <code>MessageUtil(</code> <code>final</code> <code>ConnectionFactory
connectionFactory,</code> <code>final</code> <code>long</code> <code>receiveTimeout,</code> <code>final</code> <code>List&lt;String&gt; destinationQueueNames) {</code></p>
<p><code></code> <code>this</code> <code>.connectionFactory = connectionFactory;</code></p>
<p><code></code> <code>this</code> <code>.receiveTimeout = receiveTimeout;</code></p>
<p><code></code> <code>this</code> <code>.destinationQueueNames =</code> <code>new</code> <code>ArrayList&lt;&gt;();</code></p>
<p><code></code> <code>this</code> <code>.destinationQueueNames.addAll(destinationQueueNames.stream().co
llect(Collectors.toList()));</code></p>
<p><code></code> <code>jmsTemplate =</code> <code>new</code> <code>JmsTemplate(</code> <code>this</code> <code>.connectionFactory);</code></p>
<p><code></code> <code>jmsTemplate.setReceiveTimeout(</code> <code>this</code> <code>.receiveTimeout);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>MessageUtil(ConnectionFactory connectionFactory, List&lt;String&gt;
destinationQueueNames) {</code></p>
<p><code></code> <code>this</code> <code>(connectionFactory,</code> <code>10000</code> <code>, destinationQueueNames);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>convertAndSend(Object message) {</code></p>
<p><code></code> <code>if</code> <code>(ListUtil.isEmpty(destinationQueueNames)) {</code></p>
<p><code></code> <code>logger.error(</code> <code>&quot;目标队列为空，无法发送，请检查配置！message =&gt; &quot;</code> <code>\+
message.toString());</code></p>
<p><code></code> <code>return</code> <code>;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>for</code> <code>(String dest : destinationQueueNames) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(dest, message);</code></p>
<p><code></code> <code>if</code> <code>(autoBackup) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(dest + BACKUP_QUEUE_SUFFIX, message);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>convertAndSend(Object message, MessagePostProcessor
messagePostProcessor) {</code></p>
<p><code></code> <code>if</code> <code>(ListUtil.isEmpty(destinationQueueNames)) {</code></p>
<p><code></code> <code>logger.error(</code> <code>&quot;目标队列为空，无法发送，请检查配置！message =&gt; &quot;</code> <code>\+
message.toString());</code></p>
<p><code></code> <code>return</code> <code>;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>for</code> <code>(String dest : destinationQueueNames) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(dest, message, messagePostProcessor);</code></p>
<p><code></code> <code>if</code> <code>(autoBackup) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(dest + BACKUP_QUEUE_SUFFIX, message,
messagePostProcessor);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>convertAndSend(String destinationName, Object
message) {</code></p>
<p><code></code> <code>if</code> <code>(StringUtils.isBlank(destinationName)) {</code></p>
<p><code></code> <code>logger.error(</code> <code>&quot;目标队列为空，无法发送，请检查配置！message =&gt; &quot;</code> <code>\+
message.toString());</code></p>
<p><code></code> <code>return</code> <code>;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(destinationName, message);</code></p>
<p><code></code> <code>if</code> <code>(autoBackup) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(destinationName + BACKUP_QUEUE_SUFFIX,
message);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>convertAndSend(String destinationName, Object
message, MessagePostProcessor messagePostProcessor) {</code></p>
<p><code></code> <code>if</code> <code>(StringUtils.isBlank(destinationName)) {</code></p>
<p><code></code> <code>logger.error(</code> <code>&quot;目标队列为空，无法发送，请检查配置！message =&gt; &quot;</code> <code>\+
message.toString());</code></p>
<p><code></code> <code>return</code> <code>;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(destinationName, message,
messagePostProcessor);</code></p>
<p><code></code> <code>if</code> <code>(autoBackup) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(destinationName + BACKUP_QUEUE_SUFFIX,
message, messagePostProcessor);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>static</code> <code>String getText(javax.jms.Message message) {</code></p>
<p><code></code> <code>if</code> <code>(message</code> <code>instanceof</code> <code>TextMessage) {</code></p>
<p><code></code> <code>try</code> <code>{</code></p>
<p><code></code> <code>return</code> <code>((TextMessage) message).getText();</code></p>
<p><code></code> <code>}</code> <code>catch</code> <code>(JMSException e) {</code></p>
<p><code></code> <code>return</code> <code>message.toString();</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>return</code> <code>message.toString();</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>String getFirstDestination() {</code></p>
<p><code></code> <code>if</code> <code>(ListUtil.isEmpty(destinationQueueNames)) {</code></p>
<p><code></code> <code>return</code> <code>null</code> <code>;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>return</code> <code>destinationQueueNames.get(</code> <code>0</code> <code>);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>boolean</code> <code>isAutoBackup() {</code></p>
<p><code></code> <code>return</code> <code>autoBackup;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>setAutoBackup(</code> <code>boolean</code> <code>autoBackup) {</code></p>
<p><code></code> <code>this</code> <code>.autoBackup = autoBackup;</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>其中主要就用到了convertAndSend(Object message, MessagePostProcessor<br>messagePostProcessor) 这个方法，其它代码可以无视。</p>
<p>先来模拟瞬间向MQ发送大量延时消息：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p><code>/**</code></p>
<p><code></code> <code>* 发送延时消息</code></p>
<p><code></code> <code>*</code></p>
<p><code></code> <code>* @param messageUtil</code></p>
<p><code></code> <code>*/</code></p>
<p><code>private</code> <code>static</code> <code>void</code> <code>sendScheduleMessage(MessageUtil messageUtil)
{</code></p>
<p><code></code> <code>for</code> <code>(</code> <code>int</code> <code>i =</code> <code>0</code> <code>; i &lt;</code> <code>10000</code> <code>; i++) {</code></p>
<p><code></code> <code>Object obj =</code> <code>&quot;test:&quot;</code> <code>\+ i;</code></p>
<p><code></code> <code>messageUtil.convertAndSend(obj,</code> <code>new</code> <code>ScheduleMessagePostProcessor(</code> <code>1000</code> <code>\+ i *</code> <code>1000</code> <code>));</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>这里向MQ发送了1w条延时消息，每条消息延时1秒*i，上面代码中的ScheduleMessagePostProcessor类可在上篇中找到。</p>
<p>运行完之后，MQ中应该堆积着了很多消息了：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201609/27612-20160904201313552-64
4393418.png" alt=""></p>
<p>下面的代码可以清空所有延时消息：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p><code>/**</code></p>
<p><code></code> <code>* 删除所有延时消息</code></p>
<p><code></code> <code>*</code></p>
<p><code></code> <code>* @param connectionFactory</code></p>
<p><code></code> <code>* @throws JMSException</code></p>
<p><code></code> <code>*/</code></p>
<p><code>private</code> <code>static</code> <code>void</code> <code>deleteAllScheduleMessage(</code> <code>final</code> <code>ConnectionFactory connectionFactory)</code> <code>throws</code> <code>JMSException {</code></p>
<p><code></code> <code>Connection conn = connectionFactory.createConnection();</code></p>
<p><code></code> <code>Session session = conn.createSession(</code> <code>false</code> <code>,
Session.AUTO_ACKNOWLEDGE);</code></p>
<p><code></code> <code>Destination management =
session.createTopic(ScheduledMessage.AMQ_SCHEDULER_MANAGEMENT_DESTINATION);</code></p>
<p><code></code> <code>MessageProducer producer = session.createProducer(management);</code></p>
<p><code></code> <code>Message request = session.createMessage();</code></p>
<p><code></code> <code>request.setStringProperty(ScheduledMessage.AMQ_SCHEDULER_ACTION,
ScheduledMessage.AMQ_SCHEDULER_ACTION_REMOVEALL);</code></p>
<p><code></code> <code>producer.send(request);</code></p>
<p><code>}</code></p>
<p>清空所有延时消息，有些用力过猛了，很多时候，我们只需要清理掉过期的延时消息（即：本来计划是8:00投递出去的消息，结果过了8点还没投递出去）</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p><code>/**</code></p>
<p><code></code> <code>* 删除过期的延时消息</code></p>
<p><code></code> <code>*</code></p>
<p><code></code> <code>* @param connectionFactory</code></p>
<p><code></code> <code>* @throws JMSException</code></p>
<p><code></code> <code>*/</code></p>
<p><code>private</code> <code>static</code> <code>void</code> <code>deleteExpiredScheduleMessage(</code> <code>final</code> <code>ConnectionFactory connectionFactory)</code> <code>throws</code> <code>JMSException {</code></p>
<p><code></code> <code>long</code> <code>start = System.currentTimeMillis() - TimeUnit.HOURS.toMillis(</code><br><code>12</code> <code>);</code> <code>//删除：当前时间前12小时范围的延时消息</code></p>
<p><code></code> <code>long</code> <code>end = System.currentTimeMillis();</code></p>
<p><code></code> <code>Connection conn = connectionFactory.createConnection();</code></p>
<p><code></code> <code>Session session = conn.createSession(</code> <code>false</code> <code>,
Session.AUTO_ACKNOWLEDGE);</code></p>
<p><code></code> <code>Destination management =
session.createTopic(ScheduledMessage.AMQ_SCHEDULER_MANAGEMENT_DESTINATION);</code></p>
<p><code></code> <code>MessageProducer producer = session.createProducer(management);</code></p>
<p><code></code> <code>Message request = session.createMessage();</code></p>
<p><code></code> <code>request.setStringProperty(ScheduledMessage.AMQ_SCHEDULER_ACTION,
ScheduledMessage.AMQ_SCHEDULER_ACTION_REMOVEALL);</code></p>
<p><code></code> <code>request.setStringProperty(ScheduledMessage.AMQ_SCHEDULER_ACTION_START_TIME,
Long.toString(start));</code></p>
<p><code></code> <code>request.setStringProperty(ScheduledMessage.AMQ_SCHEDULER_ACTION_END_TIME,
Long.toString(end));</code></p>
<p><code></code> <code>producer.send(request);</code></p>
<p><code>}</code></p>
<p>与上一段代码基本相似，只是多指定了删除消息的起止时间段。</p>
<p>最后贴一段spring的配置文件及main函数入口</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<pre><code> 1 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 2 &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4        xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;
 5 
 6     &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
 7         &lt;property name=&quot;connectionFactory&quot;&gt;
 8             &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
 9                 &lt;property name=&quot;brokerURL&quot;
10                           value=&quot;failover:(tcp://localhost:61616,tcp://localhost:61626)?randomize=false&amp;amp;backup=true&quot;/&gt;
11                 &lt;property name=&quot;maxThreadPoolSize&quot; value=&quot;100&quot;/&gt;
12             &lt;/bean&gt;
13         &lt;/property&gt;
14     &lt;/bean&gt;
15 
16     &lt;bean id=&quot;messageUtil&quot; class=&quot;cn.mwee.utils.mq.MessageUtil&quot;&gt;
17         &lt;constructor-arg index=&quot;0&quot; ref=&quot;jmsFactory&quot;/&gt;
18         &lt;constructor-arg index=&quot;1&quot; value=&quot;10000&quot;/&gt;
19         &lt;constructor-arg index=&quot;2&quot;&gt;
20             &lt;list&gt;
21                 &lt;value&gt;dest1&lt;/value&gt;
22                 &lt;value&gt;dest2&lt;/value&gt;
23             &lt;/list&gt;
24         &lt;/constructor-arg&gt;
25         &lt;property name=&quot;autoBackup&quot; value=&quot;true&quot;/&gt;
26     &lt;/bean&gt;
27 
28 &lt;/beans&gt;
</code></pre><p>main函数：</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p><code></code> <code>public</code> <code>static</code> <code>void</code> <code>main(String[] args)</code> <code>throws</code> <code>InterruptedException, JMSException {</code></p>
<p><code></code> <code>ApplicationContext context =</code> <code>new</code> <code>ClassPathXmlApplicationContext(</code> <code>&quot;spring-sender.xml&quot;</code> <code>);</code></p>
<p><code></code> <code>ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.</code> <code>class</code> <code>,</code> <code>&quot;jmsFactory&quot;</code> <code>);</code></p>
<p><code></code> <code>MessageUtil messageUtil = context.getBean(MessageUtil.</code> <code>class</code> <code>);</code></p>
<p><code>//        sendScheduleMessage(messageUtil);</code></p>
<p><code>//        deleteAllScheduleMessage(connectionFactory);</code></p>
<p><code></code> <code>deleteExpiredScheduleMessage(connectionFactory);</code></p>
<p><code></code> <code>}</code></p>
<p>参考文章：</p>
<p><a href="http://timbish.blogspot.com/2010/10
/enhanced-jms-scheduler-in-activemq.html" target="_blank" rel="noopener"> Enhanced JMS Scheduler in ActiveMQ </a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(7)：如何清理无效的延时消息？/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(7)：如何清理无效的延时消息？/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(6)：消息延时投递" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(6)：消息延时投递/">ActiveMQ笔记(6)：消息延时投递</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(6)：消息延时投递/">
            <time datetime="2018-04-19T16:34:21.413Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>在开发业务系统时，某些业务场景需要消息定时发送或延时发送（类似：飞信的短信定时发送需求），这时候就需要用到activemq的消息延时投递，详细的文档可参考<br><a href="http://activemq.apache.org/delay-and-schedule-message-delivery.html" target="_blank" rel="noopener"> 官网说明 </a><br>，本文只介绍二种常用的用法：</p>
<p>注：本文采用spring的JmsTemplate来发送消息</p>
<p>步骤1、  首先要修改activemq.xml配置文件，启用延时投递</p>
<pre><code>1 &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; ... schedulerSupport=&quot;true&quot; &gt;
2     ...
3   &lt;/broker&gt;
</code></pre><p>即：在broker节点加上schedulerSupport=”true”，然后重启activemq即可</p>
<p>步骤2、  定义一个MessagePostProcessor的实现类</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p>34</p>
<p>35</p>
<p>36</p>
<p>37</p>
<p>38</p>
<p><code>import</code> <code>javax.jms.JMSException;</code></p>
<p><code>import</code> <code>javax.jms.Message;</code></p>
<p><code>import</code> <code>lombok.Data;</code></p>
<p><code>import</code> <code>org.apache.activemq.ScheduledMessage;</code></p>
<p><code>import</code> <code>org.apache.commons.lang3.StringUtils;</code></p>
<p><code>import</code> <code>org.springframework.jms.core.MessagePostProcessor;</code></p>
<p><code>/**</code></p>
<p><code></code> <code>* MQ延时投递处理器（注：ActiveMQ的配置文件中，要配置schedulerSupport=&quot;true&quot;，否则不起作用）</code></p>
<p><code></code> <code>* by: 杨俊明 2016-06-16</code></p>
<p><code></code> <code>*/</code></p>
<p><code>@Data</code></p>
<p><code>public</code> <code>class</code> <code>ScheduleMessagePostProcessor</code> <code>implements</code> <code>MessagePostProcessor {</code></p>
<p><code></code> <code>private</code> <code>long</code> <code>delay = 0l;</code></p>
<p><code></code> <code>private</code> <code>String corn =</code> <code>null</code> <code>;</code></p>
<p><code></code> <code>public</code> <code>ScheduleMessagePostProcessor(</code> <code>long</code> <code>delay) {</code></p>
<p><code></code> <code>this</code> <code>.delay = delay;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>ScheduleMessagePostProcessor(String cron) {</code></p>
<p><code></code> <code>this</code> <code>.corn = cron;</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>public</code> <code>Message postProcessMessage(Message message)</code> <code>throws</code> <code>JMSException {</code></p>
<p><code></code> <code>if</code> <code>(delay &gt;</code> <code>0</code> <code>) {</code></p>
<p><code></code> <code>message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, delay);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>if</code> <code>(!StringUtils.isEmpty(corn)) {</code></p>
<p><code></code> <code>message.setStringProperty(ScheduledMessage.AMQ_SCHEDULED_CRON, corn);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>return</code> <code>message;</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>步骤3、  jmsTemplate发送示例</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p><code>Object message1 =</code> <code>&quot;corn消息内容：&quot;</code> <code>\+ DateUtil.formatDate(</code> <code>new</code> <code>Date());</code></p>
<p><code>//分 时 天 月 星期几</code></p>
<p><code>jmsTemplate.convertAndSend(message1,</code> <code>new</code> <code>ScheduleMessagePostProcessor(</code> <code>&quot;40 22 * * *&quot;</code> <code>));</code></p>
<p><code>logger.info(</code> <code>&quot;消息1：[&quot;</code> <code>\+ message1 +</code> <code>&quot;] 延时发送成功！&quot;</code> <code>);</code></p>
<p><code>jmsTemplate.convertAndSend(message1,</code> <code>new</code> <code>ScheduleMessagePostProcessor(</code> <code>&quot;50 22 * * *&quot;</code> <code>));</code></p>
<p><code>logger.info(</code> <code>&quot;消息1：[&quot;</code> <code>\+ message1 +</code> <code>&quot;] 延时发送成功！&quot;</code> <code>);</code></p>
<p><code>Object message2 =</code> <code>&quot;message：&quot;</code> <code>\+ DateUtil.formatDate(</code> <code>new</code> <code>Date());</code></p>
<p><code>jmsTemplate.convertAndSend(message2,</code> <code>new</code> <code>ScheduleMessagePostProcessor(</code> <code>30</code> <code>*</code> <code>1000</code> <code>));</code> <code>//延时30秒</code></p>
<p><code>jmsTemplate.convertAndSend(message2,</code> <code>new</code> <code>ScheduleMessagePostProcessor(</code> <code>3600</code> <code>*</code> <code>24</code> <code>*</code> <code>1000</code> <code>));</code> <code>//延时24小时</code></p>
<p><code>logger.info(</code> <code>&quot;消息2：[&quot;</code> <code>\+ message2 +</code> <code>&quot;] 延时发送成功！&quot;</code> <code>);</code></p>
<p>上面的代码演示了二种延时的用法：延时N毫秒、按corn表达式延时（注：此corn表达式并非Quartz框架中的corn表达式，而是linux中corntab<br>中的表达 式，基本顺序是”分(0-59) 时(0-23) 日(1-31) 月（1-12） 星期几(1-7) “）</p>
<p>发送成功后，可以登录activemq的webconsole查看消息的属性：</p>
<p>在scheduled面板中，可以看到延时的消息</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201606/27612-201606182302114
95-737992865.png" alt="点击看大图"></p>
<p>注：在开启消息持久化存储的前提下，就算把相应的queue在webconsole面板中删除（即删除队列），只要投递的时间尚未到，该消息也不会删除，仍然能正常延<br>时投递。</p>
<p>此外，在queues面板中，如何查看某条具体的消息，也可以通过属性发现这条消息是延时消息，参考下图：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201606/27612-201606182308471
04-233535248.png" alt="点击看大图"></p>
<p>参考文章：<br>1、 <a href="http://activemq.apache.org/delay-
and-schedule-message-delivery.html" target="_blank" rel="noopener"> Delay and Schedule Message Delivery </a></p>
<p>2、 <a href="https://zh.wikipedia.org/wiki/Cron" target="_blank" rel="noopener"> 喂鸡百科上的Corn表达式解释 </a> （中文）</p>
<p>3、 <a href="https://en.wikipedia.org/wiki/Cron" target="_blank" rel="noopener"> 喂鸡百科上的Corn表达式解释 </a> （英文）</p>
<p><a href="http://activemq.apache.org/kahadb.html" target="_blank" rel="noopener"> 4、kahaDB官方文档 </a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(6)：消息延时投递/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(6)：消息延时投递/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(5)：JMX监控" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(5)：JMX监控/">ActiveMQ笔记(5)：JMX监控</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(5)：JMX监控/">
            <time datetime="2018-04-19T16:34:21.412Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>, <a class="tag-link" href="/tags/jmx/">jmx</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>系统上线运行后，及时监控报警是很必要的手段，对于ActiveMQ而言，主要监控的指标有:MQ本身的健康状况、每个队列的生产者数量、消费者数量、队列的当前消息<br>数等。</p>
<p>ActiveMQ支持JMX监控，使用步骤如下：</p>
<p>一、  修改conf/activemq.xml</p>
<pre><code>&lt;broker … useJmx=&quot;true”&gt;
    &lt;managementContext&gt;
        &lt;managementContext createConnector=&quot;true&quot; connectorPort=“jmx端口号” connectorHost=“本机ip地址&quot; /&gt;         
    &lt;/managementContext&gt;
&lt;/broker&gt;
</code></pre><p>二、  设置jmx.access、jmx.password的文件权限</p>
<p>?</p>
<p>1</p>
<p><code>chmod</code> <code>400 conf</code> <code>/jmx</code> <code>.*</code></p>
<p>(即：将jmx.password, jmx.access这二个文件设置成只读权限，activemq出于安全考虑，要求这二个文件只读)</p>
<p>三、  修改bin\activemq 启动shell脚本</p>
<p>找到invoke_start(){ 这段，然后在前面插入：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p><code>ACTIVEMQ_CONF=“jmx.password所在位置的物理路目录&quot;</code></p>
<p><code>ACTIVEMQ_SUNJMX_START=</code> <code>&quot;-Dcom.sun.management.jmxremote.port=端口号 &quot;</code></p>
<p><code>ACTIVEMQ_SUNJMX_START=</code> <code>&quot;$ACTIVEMQ_SUNJMX_START
-Dcom.sun.management.jmxremote.password.file=${ACTIVEMQ_CONF}/jmx.password&quot;</code></p>
<p><code>ACTIVEMQ_SUNJMX_START=</code> <code>&quot;$ACTIVEMQ_SUNJMX_START
-Dcom.sun.management.jmxremote.access.file=${ACTIVEMQ_CONF}/jmx.access&quot;</code></p>
<p><code>ACTIVEMQ_SUNJMX_START=</code> <code>&quot;$ACTIVEMQ_SUNJMX_START
-Dcom.sun.management.jmxremote.ssl=false&quot;</code></p>
<p>然后重启activemq即可。</p>
<p>然后在jconsole中，可以输入 ip地址:jmx端口号</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201605/27612-20160526201918584-13
6169982.png" alt=""></p>
<p>其中username,password即jmx.password中定义的用户名和密码。</p>
<p>四、  spring中使用JMX</p>
<p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<pre><code>&lt;bean class=&quot;org.springframework.jmx.support.MBeanServerConnectionFactoryBean&quot; id=&quot;mbeanServerConnection1&quot;&gt;
    &lt;property name=&quot;serviceUrl&quot; value=&quot;${mq_jmx_url1}&quot;/&gt;
    &lt;property name=&quot;connectOnStartup&quot; value=&quot;false&quot;/&gt;
    &lt;property name=&quot;environment&quot;&gt;
        &lt;props&gt;
            &lt;prop key=&quot;java.naming.security.principal&quot;&gt;
                ${mq_jmx_user1}
            &lt;/prop&gt;
            &lt;prop key=&quot;java.naming.security.credentials&quot;&gt;
                ${mq_jmx_passwor1}
            &lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre><p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>其中serviceUrl的值类似：service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi</p>
<p>参考示例：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p><code>private List&lt;ActiveMQData&gt; getMonitorDataList(MBeanServerConnection conn,
String objectName) {</code></p>
<p><code></code> <code>List&lt;ActiveMQData&gt; datas = new ArrayList&lt;&gt;();</code></p>
<p><code></code> <code>try {</code></p>
<p><code></code> <code>ObjectName objRootName = new ObjectName(objectName);</code></p>
<p><code></code> <code>String brokerName = (String) conn.getAttribute(objRootName,</code> <code>&quot;BrokerName&quot;</code> <code>);</code></p>
<p><code></code> <code>String brokerId = (String) conn.getAttribute(objRootName,</code> <code>&quot;BrokerId&quot;</code> <code>);</code></p>
<p><code></code> <code>String openWireUrl = (String) conn.getAttribute(objRootName,</code> <code>&quot;OpenWireURL&quot;</code> <code>);</code></p>
<p><code></code> <code>//</code> <code>健康状态</code></p>
<p><code></code> <code>ObjectName healthObjName = new ObjectName(objectName +</code> <code>&quot;,service=Health&quot;</code> <code>);</code></p>
<p><code></code> <code>String healthStatus = (String) conn.getAttribute(healthObjName,</code> <code>&quot;CurrentStatus&quot;</code> <code>);</code></p>
<p><code></code> <code>//</code> <code>遍历队列</code></p>
<p><code></code> <code>ObjectName[] objectNames = (ObjectName[]) conn.getAttribute(objRootName,</code> <code>&quot;Queues&quot;</code> <code>);</code></p>
<p><code></code> <code>Arrays.</code> <code>sort</code> <code>(objectNames);</code></p>
<p><code></code> <code>List&lt;String&gt; blackList = monitorConfig.getQueueBlackList();</code></p>
<p><code></code> <code>for</code> <code>(ObjectName queueName : objectNames) {</code></p>
<p><code></code> <code>...</code></p>
<p><code></code> <code>Long queueSize = (Long) conn.getAttribute(queueName,</code> <code>&quot;QueueSize&quot;</code> <code>);</code> <code>//</code> <code>队列消息数量</code></p>
<p><code></code> <code>Long producerCount = (Long) conn.getAttribute(queueName,</code> <code>&quot;ProducerCount&quot;</code> <code>);</code> <code>//</code> <code>生产者数量</code></p>
<p><code></code> <code>Long consumerCount = (Long) conn.getAttribute(queueName,</code> <code>&quot;ConsumerCount&quot;</code> <code>);</code> <code>//</code> <code>消费者数量</code></p>
<p><code></code> <code>Long enqueueCount = (Long) conn.getAttribute(queueName,</code> <code>&quot;EnqueueCount&quot;</code> <code>);</code> <code>//</code> <code>入队消息总数</code></p>
<p><code></code> <code>Long dequeueCount = (Long) conn.getAttribute(queueName,</code> <code>&quot;DequeueCount&quot;</code> <code>);</code> <code>//</code> <code>出队消息总数</code></p>
<p><code></code> <code>...</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>} catch (Exception e) {</code></p>
<p><code></code> <code>...</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>return</code> <code>datas;</code></p>
<p><code></code> <code>}</code></p>
<p>其中objectName值，可以在jconsole中查到</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(5)：JMX监控/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(5)：JMX监控/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(3)：基于Networks of Brokers的HA方案" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(3)：基于Networks of Brokers的HA方案/">ActiveMQ笔记(3)：基于Networks of Brokers的HA方案</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(3)：基于Networks of Brokers的HA方案/">
            <time datetime="2018-04-19T16:34:21.411Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p><a href="http://blog.csdn.net/lsy0903/article/details/53413355" target="_blank" rel="noopener"> 上一篇介绍了基于ZK的ActiveMQ HA方案
</a> ，虽然理解起来比较容易，但是有二个不足：</p>
<p>1)  占用的节点数过多，1个zk集群至少3个节点，1个activemq集群也至少得3个节点，但其实正常运行时，只有一个master节点在对外响应，换句话说<br>，花6个节点的成本只为了保证1个activemq master节点的高可用，太浪费资源了。</p>
<p>2)  性能下降太明显，比起单节点的activemq，性能下降了近1个数量级。</p>
<p>这一篇将介绍基于networks of<br>brokers的HA方案，不需要借助zk等第3方组件，只需要2个activemq节点就能达到类似效果，进入正题之前，先来简单谈谈Broker这个概念。</p>
<p>Broker一词的原意是『  经纪人、中间人  』，用在ActiveMQ的构架中，即：Broker作为Producer与Consumer的中间人(或代理人)<br>，生产者不用知道消费者在哪里、如何消费这些细节，只要将消息扔给中间人Broker即可，类似的，消费者也不用关心消息是从哪个生产者过来的，它只知道这是从Bro<br>ker那里拿来的，如果画一张图来描述，就是下面这样（引用自本文最后参考文章中的图片）</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160325232947995-77
5199925.gif" alt=""></p>
<p>那么，当生产者将消息发给Broker时，会发生什么？下图描述的就是这个过程：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160325233102823-19
44467648.gif" alt=""></p>
<p>1) 生产者将消息发给Broker</p>
<p>2) Broker将消息落地存储</p>
<p>3) 然后给生产者反馈：事情我已经办妥了！</p>
<p>继续，再来看看消费者又是如何跟Broker打交道的：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160325233400479-19
84865403.gif" alt=""></p>
<p>1) Broker将接收到的消息，从db中取出</p>
<p>2) 然后发送给消费者</p>
<p>3)<br>如果消费者使用的是自动确认模式(即：Session.AUTO_ACKNOWLEDGE），则Consumer会马上告诉Broker：ok，消息我已经收到了。</p>
<p>4) 然后进行自己的业务处理</p>
<p>5) Broker一旦收到确认，将会马上更新消息的状态为已消费(或直接删除，取决于持久化的实现机制）（注：虽然图中步骤5排在步骤4之后，但是步骤4、5几乎是<br>同时发生的）</p>
<p>在一些大型应用中，如果一个Broker出现性能瓶颈抗不住压力，可能会拆分成多个Broker，如下图所示：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326143807511-76
6176344.gif" alt=""></p>
<p>(注：上图中箭头的方法并非数据流向，而应该理解成调用关系，即：Producer调用Broker1，Consumer调用Broker2…)</p>
<p>Producer将消息发送给Broker1，而Consumer从另一个Broker2接收消息，有点类似数据库读写分离的意思，这样系统的性能可以提升一定程度的<br>提升，但是问题来了，Broker1上的消息，如何  “同步”（见下面的注释）  到Broker2呢，这就依赖networkConnector的配置。</p>
<p>注：  _ 同步这个词用在这里可能不太准确，但也找不到一个更精确的词来描述，实际上，二个broker用上述机制组建成小集群后，如果生产者连接到broker1<br>，消费者连接到broker2，当消息发送到broker1后，broker1不会将该消息复制一份到broker2，而是等消费者从broker2上消费该消息时，<br>这条消息才从broker1取到broker2上，相当于此时broker2是消费者，从broker1消费了一条消息，然后broker2上就有这条消息了，最终消<br>费者才能broker2上拿到这条消息。 _</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;beans
 2         xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4         xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
 5   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&gt;
 6 
 7   &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
 8     &lt;property name=&quot;locations&quot;&gt;
 9       &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
10     &lt;/property&gt;
11   &lt;/bean&gt;
12 
13   &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;activemq-1&quot;&gt;
14     &lt;networkConnectors&gt;
15       &lt;networkConnector uri=&quot;static:(tcp://127.0.0.1:61626)&quot;/&gt;
16     &lt;/networkConnectors&gt;
17     &lt;persistenceAdapter&gt;
18       &lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;
19     &lt;/persistenceAdapter&gt;
20     &lt;transportConnectors&gt;
21       &lt;transportConnector name=&quot;openwire&quot;
22                           uri=&quot;tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
23     &lt;/transportConnectors&gt;
24   &lt;/broker&gt;
25 
26   &lt;import resource=&quot;jetty.xml&quot;/&gt;
27 &lt;/beans&gt;
</code></pre><p>View Code</p>
<p>注意：14-16行及21-22行，该Broker对外暴露616 <strong> 1  </strong> 6端口，同时”连接”到616 <strong> 2  </strong><br>6端口（即另1个broker）,最终的效果相当于，如果有producer把消息发到616 <strong> 1  </strong><br>6（broker1）,则从另一个broker(616 <strong> 2  </strong> 6端口)上也能消费这条消息。</p>
<p>明白这些基本原理后，在61626对应的activemq上，也做类似的配置，只不过”连接方向”正好相反，参考以下配置：</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;beans
 2         xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4         xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
 5   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&gt;
 6 
 7     &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
 8         &lt;property name=&quot;locations&quot;&gt;
 9             &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
10         &lt;/property&gt;
11     &lt;/bean&gt;
12 
13     &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;activemq-2&quot;&gt;
14         &lt;networkConnectors&gt;
15             &lt;networkConnector uri=&quot;static:(tcp://127.0.0.1:61616)&quot;/&gt;
16         &lt;/networkConnectors&gt;
17         &lt;persistenceAdapter&gt;
18             &lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;
19         &lt;/persistenceAdapter&gt;
20         &lt;transportConnectors&gt;
21             &lt;transportConnector name=&quot;openwire&quot;
22                                 uri=&quot;tcp://0.0.0.0:61626?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
23         &lt;/transportConnectors&gt;
24     &lt;/broker&gt;
25 
26     &lt;import resource=&quot;jetty.xml&quot;/&gt;
27 &lt;/beans&gt;
</code></pre><p>View Code</p>
<p>(注：如果希望2个activemq上都能访问admin管理界面，jetty.xml中的端口要修改，不要冲突)</p>
<p>这样，activemq-1与activemq-2这二个broker就互为主备，发给你的消息会同步到我，发给我的消息也会同步到你，实现了HA，示意图如下：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326151335604-95
1843855.png" alt=""></p>
<p>Producer与Consumer连接到activemq时，配置文件可以这么写：</p>
<p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<pre><code>1 &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
2     &lt;property name=&quot;connectionFactory&quot;&gt;
3         &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
4             &lt;!--broker服务的地址--&gt;
5             &lt;property name=&quot;brokerURL&quot; value=&quot;failover:(tcp://localhost:61616,tcp://localhost:61626)&quot;/&gt;
6             ...
7         &lt;/bean&gt;
8     &lt;/property&gt;
9 &lt;/bean&gt;
</code></pre><p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>这种HA方案的优点是占用的节点数更少(只需要2个节点),而且2个broker都可以响应消息的接收与发送，性能比zookeeper方案要好一些。</p>
<p>最后，再给一个简化配置的技巧，以上述的2节点HA方案中，二个activemq的配置文件都要加networkConnector配置，如果想减轻配置的工作量，也<br>可以只在其中一个activemq设置，参考以下片段：</p>
<pre><code>&lt;networkConnectors&gt;
  &lt;networkConnector uri=&quot;static:(tcp://127.0.0.1:61626)&quot; duplex=&quot;true&quot;/&gt;
&lt;/networkConnectors&gt;
</code></pre><p>即：在61616这个activemq的配置文件中，添加networkConnector时，增加  duplex=”true”  ，也就是双工通讯的意思，这样<br>61616与61626这二个activemq上的broker就建立了双向通讯连接，另一个activemq上就无需额外配置了（注：如果在61626上配置了，反<br>而会报错）</p>
<p><strong> 参考文章：  </strong></p>
<p><a href="http://www.jakubkorab.net/2011/11/understanding-activemq-
broker-networks.html" target="_blank" rel="noopener"> http://www.jakubkorab.net/2011/11/understanding-activemq-broker-<br>networks.html  </a></p>
<p><a href="http://activemq.apache.org/networks-of-brokers.html" target="_blank" rel="noopener"> http://activemq.apache.org/networks-of-brokers.html
</a></p>
<p><strong> 最后  </strong> 贴二段程序运行的输出日志，以说明同步机制的正确性，打消回复中“大鹏520”的顾虑： </p>
<p>背景： <em>.</em>.<em>.15 与 </em>.<em>.</em>.16 作为HA(双主)的activemq集群，发送程序只连接到15发消息，然后退出。<br>接收程序只从16上收消息，如果收到了，表明15上的消息同步到16。</p>
<p>下面是 <strong> 发送程序 </strong> 的输出片段：（注意输出日志中关于IP的部分，这是只连接到<em>.</em>.<em>.[b]15[/b]上发送的）<br>(注：部分敏感信息，比如真实IP前缀，公司package名，用</em>代替了)</p>
<p>_ 14:53:09,996 &lt;<em>.DemoSender&gt; INFO [main]: 准备发送消息… _<br>_ 14:53:10,270 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[main]: Sending: WireFormatInfo { version=11,<br>properties={TcpNoDelayEnabled=true, SizePrefixDisabled=false, CacheSize=1024,<br>StackTraceEnabled=true, CacheEnabled=true, TightEncodingEnabled=true,<br>MaxFrameSize=9223372036854775807, Host=</em>.<em>.</em>.15, MaxInactivityDuration=30000,<br>MaxInactivityDurationInitalDelay=10000}, magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:53:10,306 &lt;org.apache.activemq.transport.InactivityMonitor&gt; DEBUG<br>[ActiveMQ Transport: tcp:///<em>.</em>.<em>. <strong> 15  </strong> :61616@50616]: Using min of<br>local: WireFormatInfo { version=11, properties={TcpNoDelayEnabled=true,<br>SizePrefixDisabled=false, CacheSize=1024, StackTraceEnabled=true,<br>CacheEnabled=true, TightEncodingEnabled=true,<br>MaxFrameSize=9223372036854775807, Host=</em>.<em>.</em>.15, MaxInactivityDuration=30000,<br>MaxInactivityDurationInitalDelay=10000}, magic=[A,c,t,i,v,e,M,Q]} and remote:<br>WireFormatInfo { version=11, properties={TcpNoDelayEnabled=true,<br>SizePrefixDisabled=false, CacheSize=1024, StackTraceEnabled=true,<br>CacheEnabled=true, TightEncodingEnabled=true, MaxFrameSize=104857600,<br>MaxInactivityDuration=30000, MaxInactivityDurationInitalDelay=10000},<br>magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:53:10,306 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///<em>.</em>.<em>. <strong> 15  </strong> :61616@50616]: Received<br>WireFormat: WireFormatInfo { version=11, properties={TcpNoDelayEnabled=true,<br>SizePrefixDisabled=false, CacheSize=1024, StackTraceEnabled=true,<br>CacheEnabled=true, TightEncodingEnabled=true, MaxFrameSize=104857600,<br>MaxInactivityDuration=30000, MaxInactivityDurationInitalDelay=10000},<br>magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:53:10,306 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///</em>.<em>.</em>. <strong> 15  </strong> :61616@50616]:<br>tcp:///<em>.</em>.<em>.15:61616@50616 before negotiation: OpenWireFormat{version=11,<br>cacheEnabled=false, stackTraceEnabled=false, tightEncodingEnabled=false,<br>sizePrefixDisabled=false, maxFrameSize=9223372036854775807} _<br>_ 14:53:10,307 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///</em>.<em>.</em>. <strong> 15  </strong> :61616@50616]:<br>tcp:///<em>.</em>.<em>.15:61616@50616 after negotiation: OpenWireFormat{version=11,<br>cacheEnabled=true, stackTraceEnabled=true, tightEncodingEnabled=true,<br>sizePrefixDisabled=false, maxFrameSize=104857600} _<br>_ 14:53:10,416 &lt;org.springframework.jms.core.JmsTemplate&gt; DEBUG [main]:<br>Executing callback on JMS Session: PooledSession { ActiveMQSession {id=ID<br>:yangjunmings-MacBook-Pro.local-50615-1461480790088-1:1:1,started=false}<br>java.lang.Object@5a56cdac } _<br>_ 14:53:10,471 &lt;org.springframework.jms.core.JmsTemplate&gt; DEBUG [main]:<br>Sending created message: ActiveMQTextMessage {commandId = 0, responseRequired<br>= false, messageId = null, originalDestination = null, originalTransactionId =<br>null, producerId = null, destination = null, transactionId = null, expiration<br>= 0, timestamp = 0, arrival = 0, brokerInTime = 0, brokerOutTime = 0,<br>correlationId = null, replyTo = null, persistent = false, type = null,<br>priority = 0, groupID = null, groupSequence = 0, targetConsumerId = null,<br>compressed = false, userID = null, content = null, marshalledProperties =<br>null, dataStructure = null, redeliveryCounter = 0, size = 0, properties =<br>null, readOnlyProperties = false, readOnlyBody = false, droppable = false,<br>jmsXGroupFirstForConsumer = false, text =  message test:0  } _<br>_ 14:53:10,516 &lt;</em>.DemoSender&gt; INFO [main]:  消息0发送完成!  _<br>_ 14:53:11,520 &lt;org.springframework.jms.core.JmsTemplate&gt; DEBUG [main]:<br>Executing callback on JMS Session: PooledSession { ActiveMQSession {id=ID<br>:yangjunmings-MacBook-Pro.local-50615-1461480790088-1:1:1,started=false}<br>java.lang.Object@5a56cdac } _<br>_ 14:53:11,521 &lt;org.springframework.jms.core.JmsTemplate&gt; DEBUG [main]:<br>Sending created message: ActiveMQTextMessage {commandId = 0, responseRequired<br>= false, messageId = null, originalDestination = null, originalTransactionId =<br>null, producerId = null, destination = null, transactionId = null, expiration<br>= 0, timestamp = 0, arrival = 0, brokerInTime = 0, brokerOutTime = 0,<br>correlationId = null, replyTo = null, persistent = false, type = null,<br>priority = 0, groupID = null, groupSequence = 0, targetConsumerId = null,<br>compressed = false, userID = null, content = null, marshalledProperties =<br>null, dataStructure = null, redeliveryCounter = 0, size = 0, properties =<br>null, readOnlyProperties = false, readOnlyBody = false, droppable = false,<br>jmsXGroupFirstForConsumer = false, text = message test:1} _</p>
<p>运行完以后，关掉发送程序，然后启动 <strong> 接收程序 </strong> ：</p>
<p>_ 14:54:40,965 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[main]: Sending: WireFormatInfo { version=11,<br>properties={TcpNoDelayEnabled=true, SizePrefixDisabled=false, CacheSize=1024,<br>StackTraceEnabled=true, CacheEnabled=true, TightEncodingEnabled=true,<br>MaxFrameSize=9223372036854775807, Host=<em>.</em>.<em>.  <strong> 16 </strong> ,<br>MaxInactivityDuration=30000, MaxInactivityDurationInitalDelay=10000},<br>magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:54:41,002 &lt;org.apache.activemq.transport.InactivityMonitor&gt; DEBUG<br>[ActiveMQ Transport: tcp:///</em>.<em>.</em>.  <strong> 16 </strong> :61616@50642]: Using min of<br>local: WireFormatInfo { version=11, properties={TcpNoDelayEnabled=true,<br>SizePrefixDisabled=false, CacheSize=1024, StackTraceEnabled=true,<br>CacheEnabled=true, TightEncodingEnabled=true,<br>MaxFrameSize=9223372036854775807, Host=<em>.</em>.<em>.  <strong> 16 </strong> ,<br>MaxInactivityDuration=30000, MaxInactivityDurationInitalDelay=10000},<br>magic=[A,c,t,i,v,e,M,Q]} and remote: WireFormatInfo { version=11,<br>properties={TcpNoDelayEnabled=true, SizePrefixDisabled=false, CacheSize=1024,<br>StackTraceEnabled=true, CacheEnabled=true, TightEncodingEnabled=true,<br>MaxFrameSize=104857600, MaxInactivityDuration=30000,<br>MaxInactivityDurationInitalDelay=10000}, magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:54:41,003 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///</em>.<em>.</em>.  <strong> 16 </strong> :61616@50642]: Received<br>WireFormat: WireFormatInfo { version=11, properties={TcpNoDelayEnabled=true,<br>SizePrefixDisabled=false, CacheSize=1024, StackTraceEnabled=true,<br>CacheEnabled=true, TightEncodingEnabled=true, MaxFrameSize=104857600,<br>MaxInactivityDuration=30000, MaxInactivityDurationInitalDelay=10000},<br>magic=[A,c,t,i,v,e,M,Q]} _<br>_ 14:54:41,003 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///<em>.</em>.<em>.  <strong> 16 </strong> :61616@50642]: tcp:///</em>.<em>.</em>.  <strong><br>16 </strong> :61616@50642 before negotiation: OpenWireFormat{version=11,<br>cacheEnabled=false, stackTraceEnabled=false, tightEncodingEnabled=false,<br>sizePrefixDisabled=false, maxFrameSize=9223372036854775807} _<br>_ 14:54:41,004 &lt;org.apache.activemq.transport.WireFormatNegotiator&gt; DEBUG<br>[ActiveMQ Transport: tcp:///<em>.</em>.<em>.  <strong> 16 </strong> :61616@50642]:<br>tcp:///</em>.<em>.</em>.16:61616@50642 after negotiation: OpenWireFormat{version=11,<br>cacheEnabled=true, stackTraceEnabled=true, tightEncodingEnabled=true,<br>sizePrefixDisabled=false, maxFrameSize=104857600} _<br>_ 14:54:41,163 &lt;org.apache.activemq.thread.TaskRunnerFactory&gt; DEBUG [main]:<br>Initialized TaskRunnerFactory[ActiveMQ Session Task] using ExecutorService:<br>java.util.concurrent.ThreadPoolExecutor@485966cc[Running, pool size = 0,<br>active threads = 0, queued tasks = 0, completed tasks = 0] _<br>_ 14:54:41,181 &lt;*.DemoListener&gt; INFO [ActiveMQ Session Task-1]:  message<br>test:0  _</p>
<p>注意接收程序中IP的部分，这是从<em>.</em>.<em>.[b]16[/b]上接收到的，说明消息已经从 </em>.<em>.</em>.15同步到<em>.</em>.*.16上了，否则不可能收到消息。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(3)：基于Networks of Brokers的HA方案/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(3)：基于Networks of Brokers的HA方案/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(4)：搭建Broker集群(cluster)" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(4)：搭建Broker集群(cluster)/">ActiveMQ笔记(4)：搭建Broker集群(cluster)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(4)：搭建Broker集群(cluster)/">
            <time datetime="2018-04-19T16:34:21.411Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>, <a class="tag-link" href="/tags/集群/">集群</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="ActiveMQ笔记-4-：搭建Broker集群-cluster"><a href="#ActiveMQ笔记-4-：搭建Broker集群-cluster" class="headerlink" title="[ ActiveMQ笔记(4)：搭建Broker集群(cluster)"></a>[ ActiveMQ笔记(4)：搭建Broker集群(cluster)</h1><p>](<a href="http://blog.csdn.net/lsy0903/article/details/54862508" target="_blank" rel="noopener">http://blog.csdn.net/lsy0903/article/details/54862508</a>)</p>
<p><a href="http://blog.csdn.net/lsy0903/article/details/53413417" target="_blank" rel="noopener"> 上一篇 </a> 介绍了基于Networks<br>of Borkers的2节点HA方案，这一篇继续来折腾Networks of Brokers，当应用规模日渐增长时，2节点的broker可能仍然抗不住访问压<br>力，这时候就需要多加一些broker，弄一个更大规模的Broker集群，但是怎么合理设置broker之间的网络桥接，却是有讲究的，先来看一种不太好的设计：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326233603792-51
0527302.gif" alt=""></p>
<p>这个架构看上去没瑕疵，没毛病，3个broker之间两两互通，整体可用性极高，但是从消息的路由角度来看，却不是一个好的设计，当producer向broker1<br>发送一条消息时，Consumer得到消息的路径可能有如下2条：</p>
<p>a） producer -&gt; broker1 -&gt; broker2</p>
<p>b） producer -&gt; broker1 -&gt; broker3 -&gt; broker2</p>
<p>当broker更多时，情况会更复杂，比如下面这张图：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326234011073-18
15268387.gif" alt=""></p>
<p>消息的路由途径将会更多：</p>
<p>a) producer -&gt; broker1 -&gt; broker4</p>
<p>b) producer -&gt; broker1 -&gt; broker2 -&gt; broker4</p>
<p>c) producer -&gt; broker1 -&gt; broker2 -&gt; broker3 -&gt; broker4</p>
<p>d) producer -&gt; broker1 -&gt; broker3 -&gt; broker4</p>
<p>不难想像，每多经过一个节点，消息处理的延时将会增加一些，如果Broker越多，情况越复杂，最终系统对外表现为消息处理有时很快，有时很慢，整体性能很不稳定，所<br>以  实际生产中，不要采用所有Broker之间两两互连的方案  。</p>
<p>合理的方案如下：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326234618104-16
30004598.gif" alt=""></p>
<p>这张图的灵感，应该来自组建局域网中的星形网络，在中心放置一个Borker充当Hub，与其它所有Broker互连，这样不管Consumer连接到外围的哪个Br<br>oker，消息的路由途径都比较稳定(最多经过3个Broker)，这种架构性能虽然稳定了，但是中心的Hub就变成单点隐患，如果中间的DockerHub挂了，整<br>个系统也就废了。</p>
<p>改进后的架构如下：</p>
<p><img src="http://images2015.cnblogs.com/blog/27612/201603/27612-20160326235113183-20
49846046.png" alt=""></p>
<p>本质上仍然是一个星形网络，只不过将hub弄成二个互备，然后每个hub都与其它外围的broker相连，消费者连接到broker1/broker2/broker<br>3，生产者(Producer)连接到hub1/hub2，消息的最长路径不超过3个broker<br>(注：生产者也可以连接到broker1/2/3，与消费者一样，但是消息经过的最长路径会变成4)</p>
<p>如果以后要扩张，比如增加了Broker4,Broker5…，直接修改hub1/2上的配置，增加与新的broker的连接即可，不影响消息的路由途径长度。</p>
<p>最后，在本机演练一把，给出一些配置示例：</p>
<p>1、  端口规划</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p><code>activemq1: 61616 (broker1)</code></p>
<p><code>activemq2: 61626 (broker2)</code></p>
<p><code>activemq3: 61636 (broker3)</code></p>
<p><code>activemq4: 61646 (broker-hub1)</code></p>
<p><code>activemq5: 61656 (broker-hub2)</code></p>
<p>共5个activemq实例，端口61616、61626、61636为broker1、broker2、broker3，61645、61656为broker-<br>hub1、broker-hub2</p>
<p>2、  activemq.xml配置</p>
<p>以boker1为例，配置文件内容如下：</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;beans
 2         xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4         xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
 5   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&gt;
 6 
 7   &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
 8     &lt;property name=&quot;locations&quot;&gt;
 9       &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
10     &lt;/property&gt;
11   &lt;/bean&gt;
12 
13   &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;broker1&quot;&gt;  
14     &lt;persistenceAdapter&gt;
15       &lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;
16     &lt;/persistenceAdapter&gt;
17     &lt;transportConnectors&gt;
18       &lt;transportConnector name=&quot;openwire&quot;
19                           uri=&quot;tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
20     &lt;/transportConnectors&gt;
21   &lt;/broker&gt;
22 
23   &lt;import resource=&quot;jetty.xml&quot;/&gt;
24 &lt;/beans&gt;
</code></pre><p>View Code</p>
<p>broker2及broker3，大家参考该配置修改端口号及brokerName即可。</p>
<p>broker-hub1的配置：</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;beans
 2         xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4         xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
 5   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&gt;
 6 
 7   &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
 8     &lt;property name=&quot;locations&quot;&gt;
 9       &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
10     &lt;/property&gt;
11   &lt;/bean&gt;
12 
13   &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;broker-hub1&quot;&gt;
14     &lt;networkConnectors&gt;
15       &lt;networkConnector uri=&quot;static:(tcp://127.0.0.1:61656,tcp://127.0.0.1:61616,tcp://127.0.0.1:61626,tcp://127.0.0.1:61636)&quot; duplex=&quot;true&quot;/&gt;      
16     &lt;/networkConnectors&gt;
17     &lt;persistenceAdapter&gt;
18       &lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;
19     &lt;/persistenceAdapter&gt;
20     &lt;transportConnectors&gt;
21       &lt;transportConnector name=&quot;openwire&quot;
22                           uri=&quot;tcp://0.0.0.0:61646?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
23     &lt;/transportConnectors&gt;
24   &lt;/broker&gt;
25 
26   &lt;import resource=&quot;jetty.xml&quot;/&gt;
27 &lt;/beans&gt;
</code></pre><p>broker-hub2的配置：</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;beans
 2         xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4         xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
 5   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd&quot;&gt;
 6 
 7   &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
 8     &lt;property name=&quot;locations&quot;&gt;
 9       &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
10     &lt;/property&gt;
11   &lt;/bean&gt;
12 
13   &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;broker-hub2&quot;&gt;
14     &lt;networkConnectors&gt;   
15       &lt;networkConnector uri=&quot;static:(tcp://127.0.0.1:61616,tcp://127.0.0.1:61626,tcp://127.0.0.1:61636)&quot; duplex=&quot;true&quot;/&gt;
16     &lt;/networkConnectors&gt;
17     &lt;persistenceAdapter&gt;
18       &lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;
19     &lt;/persistenceAdapter&gt;
20     &lt;transportConnectors&gt;
21       &lt;transportConnector name=&quot;openwire&quot;
22                           uri=&quot;tcp://0.0.0.0:61656?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
23     &lt;/transportConnectors&gt;
24   &lt;/broker&gt;
25 
26   &lt;import resource=&quot;jetty.xml&quot;/&gt;
27 &lt;/beans&gt;
</code></pre><p>3、  java代码中spring配置文件</p>
<p>a)  生产者</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
 2     &lt;property name=&quot;connectionFactory&quot;&gt;
 3         &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
 4             &lt;!--broker服务的地址--&gt;
 5             &lt;property name=&quot;brokerURL&quot; value=&quot;failover:(tcp://localhost:61646,tcp://localhost:61656)&quot;/&gt;
 6             &lt;!--默认值为1000,如果不需要这么大,可以调小--&gt;
 7             &lt;property name=&quot;maxThreadPoolSize&quot; value=&quot;100&quot;/&gt;
 8             &lt;!--&lt;property name=&quot;userName&quot; value=&quot;system&quot;/&gt;--&gt;
 9             &lt;!--&lt;property name=&quot;password&quot; value=&quot;manager&quot;/&gt;--&gt;
10         &lt;/bean&gt;
11     &lt;/property&gt;
12 &lt;/bean&gt;
</code></pre><p>b)  消费者</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
 2     &lt;property name=&quot;connectionFactory&quot;&gt;
 3         &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
 4             &lt;!--broker服务的地址--&gt;
 5             &lt;property name=&quot;brokerURL&quot; value=&quot;failover:(tcp://localhost:61616,tcp://localhost:61626,tcp://localhost:61636)&quot;/&gt;
 6             &lt;!--默认值为1000,如果不需要这么大,可以调小--&gt;
 7             &lt;property name=&quot;maxThreadPoolSize&quot; value=&quot;100&quot;/&gt;
 8             &lt;!--&lt;property name=&quot;userName&quot; value=&quot;system&quot;/&gt;--&gt;
 9             &lt;!--&lt;property name=&quot;password&quot; value=&quot;manager&quot;/&gt;--&gt;
10         &lt;/bean&gt;
11     &lt;/property&gt;
12 &lt;/bean&gt;
</code></pre>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(4)：搭建Broker集群(cluster)/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(4)：搭建Broker集群(cluster)/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(2)：基于ZooKeeper的HA方案" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(2)：基于ZooKeeper的HA方案/">ActiveMQ笔记(2)：基于ZooKeeper的HA方案</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(2)：基于ZooKeeper的HA方案/">
            <time datetime="2018-04-19T16:34:21.410Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>, <a class="tag-link" href="/tags/zookeeper/">zookeeper</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>activemq官网给出了3种master/slave的HA方案，详见： <a href="http://activemq.apache.org/masterslave.html" target="_blank" rel="noopener"><br>http://activemq.apache.org/masterslave.html
</a> ，基于共享文件目录，db，zookeeper。</p>
<p>下面演示了如何在本机搭建基于zookeeper的activemq集群：</p>
<p>一、  在目录activemq1下安装activemq(可参考 <a href="http://blog.csdn.net/lsy0903/article/details/53413271" target="_blank" rel="noopener"> 上篇内容
</a><br>)，然后修改conf/activemq.xml</p>
<p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<pre><code> 1     &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;localhost&quot; dataDirectory=&quot;${activemq.data}&quot;&gt;
 2         ...
 3         &lt;persistenceAdapter&gt;
 4             &lt;!--&lt;kahaDB directory=&quot;${activemq.data}/kahadb&quot;/&gt;--&gt;
 5             &lt;replicatedLevelDB
 6                     directory=&quot;activemq-data&quot;
 7                     replicas=&quot;3&quot;
 8                     bind=&quot;tcp://0.0.0.0:0&quot;
 9                     zkAddress=&quot;127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183&quot;
10                     zkSessionTimeout=&quot;2s&quot;
11                     zkPath=&quot;/activemq/leveldb-stores&quot;
12             /&gt;
13         &lt;/persistenceAdapter&gt;
14         ...
15     &lt;/broker&gt;
</code></pre><p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>注：为保证zk的HA，本机至少要有3个zk的节点，可参考 <a href="http://www.cnblogs.com/yjmyzz/p/4587663.html" target="_blank" rel="noopener"> 我以前的文章
</a> 搭建.</p>
<p>二、  将activemq1复制二分，变成activemq2、activemq3，由于是在本机测试，为防止端口冲突，这二个目录下的activemq.xml，<br>得修改端口</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p><code>&lt;transportConnectors&gt;</code></p>
<p><code></code> <code>&lt;transportConnector name=</code> <code>&quot;openwire&quot;</code></p>
<p><code></code> <code>uri=</code> <code>&quot;tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFram
eSize=104857600&quot;</code> <code>/&gt;</code></p>
<p><code></code> <code>&lt;transportConnector name=</code> <code>&quot;amqp&quot;</code></p>
<p><code></code> <code>uri=</code> <code>&quot;amqp://0.0.0.0:5672?maximumConnections=1000&amp;wireFormat.maxFram
eSize=104857600&quot;</code> <code>/&gt;</code></p>
<p><code></code> <code>&lt;transportConnector name=</code> <code>&quot;stomp&quot;</code></p>
<p><code></code> <code>uri=</code> <code>&quot;stomp://0.0.0.0:61613?maximumConnections=1000&amp;wireFormat.maxFr
ameSize=104857600&quot;</code> <code>/&gt;</code></p>
<p><code></code> <code>&lt;transportConnector name=</code> <code>&quot;mqtt&quot;</code></p>
<p><code></code> <code>uri=</code> <code>&quot;mqtt://0.0.0.0:1883?maximumConnections=1000&amp;wireFormat.maxFram
eSize=104857600&quot;</code> <code>/&gt;</code></p>
<p><code></code> <code>&lt;transportConnector name=</code> <code>&quot;ws&quot;</code></p>
<p><code></code> <code>uri=</code> <code>&quot;ws://0.0.0.0:61614?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600&quot;</code> <code>/&gt;</code></p>
<p><code>&lt;/transportConnectors&gt;</code></p>
<p>上面这几个端口，大家看情况调整，只要保证3个activemq不冲突即可</p>
<p>三、  启动zk1,zk2,zk3，以及activemq1,activemq2,activemq3即可。</p>
<p>注：为方便观察输出，建议启动activemq时，用./activemq.sh console启动</p>
<p>四、  测试Failover</p>
<p>正常启动后，然后手动停掉master，然后观察剩下的2个节点终端输出，正常情况下，应该过一会儿，有一个会自动提升为master.</p>
<p>最后提醒一下：采用上述HA方案后，虽然系统可用性提高了，但是在本机上测试发现，跟 <a href="http://www.cnblogs.com/yjmyzz/p/activemq-sample.html" target="_blank" rel="noopener"> 上篇
</a> 同样的测试代码和用例，单节点运行时，1秒可以<br>发8k+条消息，采用zookeeper的HA方案后，每秒只能写入500条消息左右，对于性能要求较高的场景，建议采用其它方案，比如下一篇要介绍的 <a href="http://www.cnblogs.com/yjmyzz/p/activemq-ha-
using-networks-of-brokers.html" target="_blank" rel="noopener"><br>基于Networks of brokers的HA方案 </a> 。</p>
<p><strong> 参考文章： </strong></p>
<p><a href="http://activemq.apache.org/replicated-leveldb-store.html" target="_blank" rel="noopener"> </a> <a href="http://activemq.apache.org/replicated-leveldb-store.html" target="_blank" rel="noopener"><br>http://activemq.apache.org/replicated-leveldb-store.html
</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(2)：基于ZooKeeper的HA方案/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(2)：基于ZooKeeper的HA方案/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-ActiveMQ笔记(1)：编译、安装、示例代码" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/ActiveMQ笔记(1)：编译、安装、示例代码/">ActiveMQ笔记(1)：编译、安装、示例代码</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/ActiveMQ笔记(1)：编译、安装、示例代码/">
            <time datetime="2018-04-19T16:34:21.409Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/ActiveMQ/">ActiveMQ</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/activemq/">activemq</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>一、编译</p>
<p>虽然 <a href="http://activemq.apache.org/" target="_blank" rel="noopener"> ActiveMQ </a><br>提供了发布版本，但是建议同学们自己下载源代码编译，以后万一有坑，还可以尝试自己改改源码。</p>
<p>1.1  <a href="https://github.com/apache/activemq/releases" target="_blank" rel="noopener"> https://github.com/apache/activemq/releases
</a><br>到这里下载最新的release版源码（当前最新版本为5.13.2），并解压到某个目录(以下用$ACTIVEMQ_HOME代替解压根目录)</p>
<p>1.2  编译</p>
<p>1</p>
<p>2</p>
<p><code>cd</code> <code>$ACTIVEMQ_HOME</code></p>
<p><code>mvn clean</code> <code>install</code> <code>-Dmaven.</code> <code>test</code> <code>.skip=</code> <code>true</code></p>
<p>编译成功后，在$ACTIVEMQ_HOME  /assembly/target下会生成可xxx.bin.tar.gz的可执行文件压缩包</p>
<p>二、启动</p>
<p>将编译后得到的xxx.bin.tar.gz解压，然后执行</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p><code>tar</code> <code>-zxvf apache-activemq-5.13.2-bin.</code> <code>tar</code> <code>.gz</code></p>
<p><code>cd</code> <code>apache-activemq-5.13.2</code> <code>/bin</code></p>
<p><code>.</code> <code>/activemq</code> <code>start</code></p>
<p>后面的可选参数还有 status、restart、stop、list等，不清楚的地方，直接 –help 查看。</p>
<p>注：  生产环境中，可能会对activemq的jvm内存设置上限，可以直接修改bin/activemq启动脚本，vi bin/activemq<br>找到下面的位置：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p><code># Note: This function uses globally defined variables</code></p>
<p><code># - $ACTIVEMQ_PIDFILE : the name of the pid file&lt;/code&gt;&lt;/div&gt;&lt;div
class=&quot;line number3 index2 alt2&quot;&gt;&lt;code class=&quot;bash comments&quot;&gt;# -
$ACTIVEMQ_OPTS : Additional options</code></p>
<p><code>ACTIVEMQ_OPTS=</code> <code>&quot;-server -Xms512M -Xmx512M -XX:PermSize=64M
-XX:MaxPermSize=128M &quot;</code></p>
<p><code># - $ACTIVEMQ_SUNJMX_START : options for JMX settings&lt;/code&gt;&lt;/div&gt;&lt;div
class=&quot;line number6 index5 alt1&quot;&gt;&lt;code class=&quot;bash comments&quot;&gt;# -
$ACTIVEMQ_SSL_OPTS : options for SSL encryption</code></p>
<p>设置ACTIVEMQ_OPTS即可，然后重启activemq，建议启动成功后，用jinfo {activemq的pid} 来验证查看一下</p>
<p>三、管理界面</p>
<p>启动成功后，可以浏览 <a href="http://localhost:8161/admin/" target="_blank" rel="noopener"> http://localhost:8161/admin/ </a></p>
<p>默认用户名、密码：admin/admin</p>
<p>管理界面是用jetty做容器的，如果想修改管理界面的端口，可以编辑../conf/jetty.xml，找到下面这一段：</p>
<pre><code>&lt;bean id=&quot;jettyPort&quot; class=&quot;org.apache.activemq.web.WebConsolePort&quot; init-method=&quot;start&quot;&gt;
    &lt;!-- the default port number for the web console --&gt;
    &lt;property name=&quot;host&quot; value=&quot;0.0.0.0&quot;/&gt;
    &lt;property name=&quot;port&quot; value=&quot;8161&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>用户名/密码是在 ../conf/jetty-realm.properties 里，比如要增加一个管理员jimmy/123456，可参考下面修改：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p><code>admin: admin, admin</code></p>
<p><code>jimmy: 123456, admin</code></p>
<p><code>user: user, user</code></p>
<p>注：  管理界面有一个  小坑  ，ActiveMQ 5.13.  2  与jdk1.8兼容性有点问题，如果使用jdk1.8，管理界面进入Queues标签页<br>时，偶尔会报错，但是并不影响消息正常收发，只是无法从界面上查看队列情况，如果出现该问题，可将jdk版本降至1.7，同时最好清空data目录下的所有数据，再重<br>启activemq即可。</p>
<p>2016-06-18 注：  最新版的5.13.  3  已经修复了这个bug，建议大家使用最新版本。</p>
<p>四、示例代码</p>
<p>通常消息队列都支持二种模式：基于主题(topic)的发布(Publish)/订阅(Subscribe)模式、点对点(p2p)模式，下面的示例代码为p2p场景<br>。</p>
<p>先给出gradle项目的依赖项</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p><code>dependencies {</code></p>
<p><code></code> <code>compile</code> <code>&quot;org.springframework:spring-core:4.2.5.RELEASE&quot;</code></p>
<p><code></code> <code>compile</code> <code>&quot;org.springframework:spring-beans:4.2.5.RELEASE&quot;</code></p>
<p><code></code> <code>compile</code> <code>&quot;org.springframework:spring-context:4.2.5.RELEASE&quot;</code></p>
<p><code></code> <code>compile</code> <code>&quot;org.springframework:spring-jms:4.2.3.RELEASE&quot;</code></p>
<p><code></code> <code>compile</code> <code>&#39;org.apache.activemq:activemq-all:5.13.2&#39;</code></p>
<p><code></code> <code>compile</code> <code>&#39;org.apache.commons:commons-pool2:2.4.2&#39;</code></p>
<p><code></code> <code>testCompile group:</code> <code>&#39;junit&#39;</code> <code>, name:</code> <code>&#39;junit&#39;</code> <code>, version:</code><br><code>&#39;4.12&#39;</code></p>
<p><code>}</code></p>
<p>4.1  spring配置文件</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 2 &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
 3        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
 4        xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;
 5 
 6     &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
 7         &lt;property name=&quot;connectionFactory&quot;&gt;
 8             &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
 9                 &lt;!--broker服务的地址--&gt;
10                 &lt;property name=&quot;brokerURL&quot; value=&quot;tcp://localhost:61616&quot;/&gt;
11                 &lt;!--默认值为1000,如果不需要这么大,可以调小--&gt;
12                 &lt;property name=&quot;maxThreadPoolSize&quot; value=&quot;100&quot;/&gt;
13             &lt;/bean&gt;
14         &lt;/property&gt;
15     &lt;/bean&gt;
16 
17     &lt;bean id=&quot;dest&quot; class=&quot;org.apache.activemq.command.ActiveMQQueue&quot;&gt;
18         &lt;!--队列名称--&gt;
19         &lt;property name=&quot;physicalName&quot; value=&quot;myQueue&quot;/&gt;
20     &lt;/bean&gt;
21 
22     &lt;bean id=&quot;myJmsTemplate&quot; class=&quot;org.springframework.jms.core.JmsTemplate&quot;&gt;
23         &lt;property name=&quot;connectionFactory&quot; ref=&quot;jmsFactory&quot;/&gt;
24         &lt;!--默认的队列--&gt;
25         &lt;property name=&quot;defaultDestination&quot; ref=&quot;dest&quot;/&gt;
26         &lt;!--接收超时时间10秒--&gt;
27         &lt;property name=&quot;receiveTimeout&quot; value=&quot;10000&quot;/&gt;
28     &lt;/bean&gt;
29 
30 &lt;/beans&gt;
</code></pre><p>View Code</p>
<p>注：brokerURL的地址是在conf/activemq.xml里定义里，见下面的片段</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code>1 &lt;transportConnectors&gt;
2  &lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;
3  &lt;transportConnector name=&quot;openwire&quot; uri=&quot;tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
4  &lt;transportConnector name=&quot;amqp&quot; uri=&quot;amqp://0.0.0.0:5672?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
5  &lt;transportConnector name=&quot;stomp&quot; uri=&quot;stomp://0.0.0.0:61613?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
6  &lt;transportConnector name=&quot;mqtt&quot; uri=&quot;mqtt://0.0.0.0:1883?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
7  &lt;transportConnector name=&quot;ws&quot; uri=&quot;ws://0.0.0.0:61614?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;/&gt;
8 &lt;/transportConnectors&gt;
</code></pre><p>View Code</p>
<p>另外，连接ActiveMQ默认情况下，没有任何安全机制，也就是说任何人只要知道brokerURL都能连接，这显然不安全，可以在activemq.xml里，找<br>到<broker>节点，紧贴它的地方添加下面这段：</broker></p>
<p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<pre><code>    &lt;broker xmlns=&quot;http://activemq.apache.org/schema/core&quot; brokerName=&quot;localhost&quot; dataDirectory=&quot;${activemq.data}&quot;&gt;

        &lt;plugins&gt;   
            &lt;simpleAuthenticationPlugin&gt;   
                &lt;users&gt;   
                    &lt;authenticationUser username=&quot;${activemq.username}&quot;&lt;/span&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; password&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;=&quot;${activemq.password}&quot; groups=&quot;users,admins&quot;/&gt;   
                &lt;/users&gt;   
            &lt;/simpleAuthenticationPlugin&gt;   
        &lt;/plugins&gt;
...
   &lt;/broker&gt;
</code></pre><p><img src="//common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>那么问题来了，这个  activemq.username&#x53CA;” role=”presentation”&gt; a  c  t  i  v  e  m<br>q  .  u  s  e  r  n  a  m  e  及  activemq.username及<br>{activemq.password}的值是在哪里定义的呢？仍然在activemq.xml里找答案，在最开始的地方有一段：</p>
<pre><code>1 &lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
2     &lt;property name=&quot;locations&quot;&gt;
3         &lt;value&gt;file:${activemq.conf}/credentials.properties&lt;/value&gt;
4     &lt;/property&gt;
5 &lt;/bean&gt;
</code></pre><p>换句话说，conf/credentials.properties这里保存的就是连接activemq的用户名和密码，启用连接的安全机制后，spring的配置文<br>件要做如下调整：</p>
<p><img src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt=""><br><img src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt=""></p>
<pre><code> 1 &lt;bean id=&quot;jmsFactory&quot; class=&quot;org.apache.activemq.pool.PooledConnectionFactory&quot; destroy-method=&quot;stop&quot;&gt;
 2     &lt;property name=&quot;connectionFactory&quot;&gt;
 3         &lt;bean class=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot;&gt;
 4             &lt;!--broker服务的地址--&gt;
 5             &lt;property name=&quot;brokerURL&quot; value=&quot;tcp://localhost:61616&quot;/&gt;
 6             &lt;!--默认值为1000,如果不需要这么大,可以调小--&gt;
 7             &lt;property name=&quot;maxThreadPoolSize&quot; value=&quot;100&quot;/&gt;
 8             &lt;property name=&quot;userName&quot; value=&quot;system&quot;/&gt;
 9             &lt;property name=&quot;password&quot; value=&quot;manager&quot;/&gt;
10         &lt;/bean&gt;
11     &lt;/property&gt;
12 &lt;/bean&gt;
</code></pre><p>View Code</p>
<p>4.2  生产者代码</p>
<p>发送消息的代码有二种写法：</p>
<p>a）  利用spring-jms的JmsTemplate</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p><code>package</code> <code>com.cnblogs.yjmyzz.activemq;</code></p>
<p><code>import</code> <code>org.springframework.context.ApplicationContext;</code></p>
<p><code>import</code> <code>org.springframework.context.support.ClassPathXmlApplicationContext;</code></p>
<p><code>import</code> <code>org.springframework.jms.core.JmsTemplate;</code></p>
<p><code>/**</code></p>
<p><code></code> <code>* ActiveMQ消息发送示例（利用JMSTemplate）</code></p>
<p><code></code> <code>* Author:菩提树下的杨过 http://yjmyzz.cnblogs.com</code></p>
<p><code></code> <code>*/</code></p>
<p><code>public</code> <code>class</code> <code>JmsTemplateProducer {</code></p>
<p><code></code> <code>public</code> <code>static</code> <code>void</code> <code>main(String[] args) {</code></p>
<p><code></code> <code>ApplicationContext context =</code> <code>new</code> <code>ClassPathXmlApplicationContext(</code> <code>&quot;spring-context.xml&quot;</code> <code>);</code></p>
<p><code></code> <code>JmsTemplate jmsTemplate = context.getBean(JmsTemplate.</code> <code>class</code> <code>);</code></p>
<p><code></code> <code>System.out.println(</code> <code>&quot;准备发送消息...&quot;</code> <code>);</code></p>
<p><code></code> <code>int</code> <code>max =</code> <code>100000</code> <code>;</code></p>
<p><code></code> <code>Long start = System.currentTimeMillis();</code></p>
<p><code></code> <code>for</code> <code>(</code> <code>int</code> <code>i =</code> <code>0</code> <code>; i &lt; max; i++) {</code></p>
<p><code></code> <code>jmsTemplate.convertAndSend(</code> <code>&quot;message test:&quot;</code> <code>\+ i);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>Long end = System.currentTimeMillis();</code></p>
<p><code></code> <code>Long elapse = end - start;</code></p>
<p><code></code> <code>int</code> <code>perform = Double.valueOf(max / (elapse / 1000d)).intValue();</code></p>
<p><code></code> <code>System.out.print(</code> <code>&quot;发送 &quot;</code> <code>\+ max +</code> <code>&quot; 条消息，耗时：&quot;</code> <code>\+ elapse +</code> <code>&quot;毫秒，平均&quot;</code> <code>\+ perform +</code> <code>&quot;条/秒&quot;</code> <code>);</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>b)  利用activeMQ的Producer</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p>34</p>
<p>35</p>
<p>36</p>
<p>37</p>
<p>38</p>
<p>39</p>
<p>40</p>
<p>41</p>
<p>42</p>
<p>43</p>
<p>44</p>
<p>45</p>
<p>46</p>
<p><code>package</code> <code>com.cnblogs.yjmyzz.activemq;</code></p>
<p><code>import</code> <code>org.apache.activemq.command.ActiveMQQueue;</code></p>
<p><code>import</code> <code>org.apache.activemq.pool.PooledConnectionFactory;</code></p>
<p><code>import</code> <code>org.springframework.context.ApplicationContext;</code></p>
<p><code>import</code> <code>org.springframework.context.support.ClassPathXmlApplicationContext;</code></p>
<p><code>import</code> <code>javax.jms.*;</code></p>
<p><code>import</code> <code>java.io.IOException;</code></p>
<p><code>/**</code></p>
<p><code></code> <code>* ActiveMQ消息发送示例（利用Producer）</code></p>
<p><code></code> <code>* Author:菩提树下的杨过 http://yjmyzz.cnblogs.com</code></p>
<p><code></code> <code>*/</code></p>
<p><code>public</code> <code>class</code> <code>ActiveMQProducer {</code></p>
<p><code></code> <code>public</code> <code>static</code> <code>void</code> <code>main(String[] args)</code> <code>throws</code> <code>JMSException, IOException, InterruptedException {</code></p>
<p><code></code> <code>ApplicationContext context =</code> <code>new</code> <code>ClassPathXmlApplicationContext(</code> <code>&quot;spring-context.xml&quot;</code> <code>);</code></p>
<p><code></code> <code>PooledConnectionFactory connectionFactory =
context.getBean(PooledConnectionFactory.</code> <code>class</code> <code>);</code></p>
<p><code></code> <code>ActiveMQQueue destination = context.getBean(ActiveMQQueue.</code> <code>class</code> <code>);</code></p>
<p><code></code> <code>Connection connection = connectionFactory.createConnection();</code></p>
<p><code></code> <code>connection.start();</code></p>
<p><code></code> <code>Session session = connection.createSession(</code> <code>false</code> <code>,
Session.AUTO_ACKNOWLEDGE);</code></p>
<p><code></code> <code>MessageProducer producer = session.createProducer(destination);</code></p>
<p><code></code> <code>System.out.println(</code> <code>&quot;准备发送消息...&quot;</code> <code>);</code></p>
<p><code></code> <code>int</code> <code>max =</code> <code>100000</code> <code>;</code></p>
<p><code></code> <code>Long start = System.currentTimeMillis();</code></p>
<p><code></code> <code>for</code> <code>(</code> <code>int</code> <code>i =</code> <code>0</code> <code>; i &lt; max; i++) {</code></p>
<p><code></code> <code>TextMessage msg = session.createTextMessage(</code> <code>&quot;message test:&quot;</code> <code>\+
i);</code></p>
<p><code></code> <code>//msg.setIntProperty(&quot;id&quot;, i);</code></p>
<p><code></code> <code>producer.send(msg);</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>Long end = System.currentTimeMillis();</code></p>
<p><code></code> <code>Long elapse = end - start;</code></p>
<p><code></code> <code>int</code> <code>perform = Double.valueOf(max / (elapse / 1000d)).intValue();</code></p>
<p><code></code> <code>System.out.print(</code> <code>&quot;发送 &quot;</code> <code>\+ max +</code> <code>&quot; 条消息，耗时：&quot;</code> <code>\+ elapse +</code> <code>&quot;毫秒，平均&quot;</code> <code>\+ perform +</code> <code>&quot;条/秒&quot;</code> <code>);</code></p>
<p><code></code> <code>//producer.send(session.createTextMessage(&quot;SHUTDOWN&quot;));</code></p>
<p><code></code> <code>//Thread.sleep(1000 * 3);</code></p>
<p><code></code> <code>//connection.close();</code></p>
<p><code></code> <code>System.exit(</code> <code>0</code> <code>);</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>这二种方式在性能上差不多，4核8G的mac book<br>pro上，大致每秒可以写入3k+条消息。但是从代码量来讲，明显JmsTemplate的代码量更少，推荐使用。</p>
<p>4.3  消费者代码</p>
<p>当然也可以用JmsTemplate接收消息，但是一般得自己去写while(true)循环，而且默认情况下，上下文如果不是同一个连接，JmsTemplate<br>A发出的消息，JmsTemplate<br>B是接收不到的，所以不建议这种方式。最好参考下面的示例，使用JMS的MessageLisenter去监听消息，这也是JMS规范建议的标准做法：</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p>14</p>
<p>15</p>
<p>16</p>
<p>17</p>
<p>18</p>
<p>19</p>
<p>20</p>
<p>21</p>
<p>22</p>
<p>23</p>
<p>24</p>
<p>25</p>
<p>26</p>
<p>27</p>
<p>28</p>
<p>29</p>
<p>30</p>
<p>31</p>
<p>32</p>
<p>33</p>
<p>34</p>
<p>35</p>
<p>36</p>
<p>37</p>
<p>38</p>
<p>39</p>
<p>40</p>
<p>41</p>
<p>42</p>
<p><code>package</code> <code>com.cnblogs.yjmyzz.activemq;</code></p>
<p><code>import</code> <code>org.apache.activemq.command.ActiveMQQueue;</code></p>
<p><code>import</code> <code>org.apache.activemq.pool.PooledConnectionFactory;</code></p>
<p><code>import</code> <code>org.springframework.context.ApplicationContext;</code></p>
<p><code>import</code> <code>org.springframework.context.support.ClassPathXmlApplicationContext;</code></p>
<p><code>import</code> <code>javax.jms.*;</code></p>
<p><code>import</code> <code>java.io.IOException;</code></p>
<p><code>/**</code></p>
<p><code></code> <code>* ActiveMQ消息接收示例(使用MessageListener)</code></p>
<p><code></code> <code>* Author:菩提树下的杨过 http://yjmyzz.cnblogs.com</code></p>
<p><code></code> <code>*/</code></p>
<p><code>public</code> <code>class</code> <code>MessageListenerConsumer {</code></p>
<p><code></code> <code>public</code> <code>static</code> <code>void</code> <code>main(String[] args)</code> <code>throws</code> <code>JMSException, IOException {</code></p>
<p><code></code> <code>ApplicationContext context =</code> <code>new</code> <code>ClassPathXmlApplicationContext(</code> <code>&quot;spring-context.xml&quot;</code> <code>);</code></p>
<p><code></code> <code>PooledConnectionFactory connectionFactory =
context.getBean(PooledConnectionFactory.</code> <code>class</code> <code>);</code></p>
<p><code></code> <code>ActiveMQQueue destination = context.getBean(ActiveMQQueue.</code> <code>class</code> <code>);</code></p>
<p><code></code> <code>Connection connection = connectionFactory.createConnection();</code></p>
<p><code></code> <code>connection.start();</code></p>
<p><code></code> <code>Session session = connection.createSession(</code> <code>false</code> <code>,
Session.AUTO_ACKNOWLEDGE);</code></p>
<p><code></code> <code>MessageConsumer consumer = session.createConsumer(destination);</code></p>
<p><code></code> <code>consumer.setMessageListener(</code> <code>new</code> <code>ActiveMQListener());</code></p>
<p><code></code> <code>System.in.read();</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>static</code> <code>class</code> <code>ActiveMQListener</code> <code>implements</code> <code>MessageListener
{</code></p>
<p><code></code> <code>@Override</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>onMessage(Message message) {</code></p>
<p><code></code> <code>try</code> <code>{</code></p>
<p><code></code> <code>if</code> <code>(message</code> <code>instanceof</code> <code>TextMessage) {</code></p>
<p><code></code> <code>System.out.println(((TextMessage) message).getText());</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code> <code>catch</code> <code>(JMSException e) {</code></p>
<p><code></code> <code>e.printStackTrace();</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>4.4  嵌入式Broker</p>
<p>类似jetty、tombat之类可以内嵌到代码中启动一样，ActiveMQ也可以直接在代码中内嵌启动，这个很方便一些轻量级的使用场景，示例代码如下：</p>
<p>+ View Code  ?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p><code>public</code> <code>class</code> <code>EmbbedBroker {</code></p>
<p><code></code> <code>public</code> <code>static</code> <code>void</code> <code>main(String[] args)</code> <code>throws</code> <code>Exception {</code></p>
<p><code></code> <code>BrokerService broker =</code> <code>new</code> <code>BrokerService();</code></p>
<p><code></code> <code>broker.addConnector(</code> <code>&quot;tcp://localhost:61616&quot;</code> <code>);</code></p>
<p><code></code> <code>broker.start();</code></p>
<p><code></code> <code>System.out.println(</code> <code>&quot;ActiveMQ 已启动!&quot;</code> <code>);</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>
<p>关于嵌入式Broker的更多细节，可以参考 <a href="http://activemq.apache.org/how-do-i-embed-a-broker-
inside-a-connection.html" target="_blank" rel="noopener"> http://activemq.apache.org/how-do-i-embed-a-broker-<br>inside-a-connection.html </a></p>
<p>4.5  消息的自动确认与手动确认</p>
<p>在接收消息时，如果Session使用的是 Session.AUTO_ACKNOWLEDGE，即：</p>
<p>?</p>
<p>1</p>
<p><code>Session session = connection.createSession(</code> <code>false</code> <code>,
Session.AUTO_ACKNOWLEDGE);</code></p>
<p>则消息一旦被接受，不论onMessage()里的业务逻辑执行成功与否，消息都将从ActiveMQ的队列里立刻删除。如果希望业务处理成功后，再通知Active<br>MQ删除消息，可以改成：</p>
<p>?</p>
<p>1</p>
<p><code>Session session = connection.createSession(</code> <code>false</code> <code>,
Session.CLIENT_ACKNOWLEDGE);</code></p>
<p>然后onMessage方法调用message.acknowledge手动确认，参考以下代码：</p>
<p>?</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>9</p>
<p>10</p>
<p>11</p>
<p>12</p>
<p>13</p>
<p><code>static</code> <code>class</code> <code>ActiveMQListener</code> <code>implements</code> <code>MessageListener {</code></p>
<p><code></code> <code>@Override</code></p>
<p><code></code> <code>public</code> <code>void</code> <code>onMessage(Message message) {</code></p>
<p><code></code> <code>try</code> <code>{</code></p>
<p><code></code> <code>if</code> <code>(message</code> <code>instanceof</code> <code>TextMessage) {</code></p>
<p><code></code> <code>System.out.println(((TextMessage) message).getText());</code></p>
<p><code></code> <code>message.acknowledge();</code> <code>//手动确认消息</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code> <code>catch</code> <code>(JMSException e) {</code></p>
<p><code></code> <code>e.printStackTrace();</code></p>
<p><code></code> <code>}</code></p>
<p><code></code> <code>}</code></p>
<p><code>}</code></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/ActiveMQ笔记(1)：编译、安装、示例代码/#comments" id="sourceId::2018/04/20/ActiveMQ笔记(1)：编译、安装、示例代码/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <article id="post-7个步骤让PC网站自动适配手机网页" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2018/04/20/7个步骤让PC网站自动适配手机网页/">7个步骤让PC网站自动适配手机网页</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2018/04/20/7个步骤让PC网站自动适配手机网页/">
            <time datetime="2018-04-19T16:34:21.408Z" itemprop="datePublished">2018-04-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/web前端/">web前端</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/优化/">优化</a>, <a class="tag-link" href="/tags/搜索引擎/">搜索引擎</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>传统的网站如何完成向移动设备的快速转型？ 通过移动适配技术可以实现，切图网是国内首家基于web技术服务的公司，而移动适配主要通过底层的web技术开发手段来完<br>成，下面切图网将从技术角度来告诉你通过7个步骤来完成一个PC网站向移动设备的跳跃！</p>
<p>1允许网页宽度自动调整</p>
<p>“自适应网页设计”到底是怎么做到的？其实并不难。</p>
<p>首先，在网页代码的头部，加入一行viewport元标签。</p>
<p>viewport是网页默认的宽度和高度，上面这行代码的意思是，网页宽度默认等于屏幕宽度（width=device-width），原始缩放比例<br>（initial-scale=1）为1.0，即网页初始大小占屏幕面积的100%。</p>
<p>所有主流浏览器都支持这个设置，包括IE9。对于那些老式浏览器（主要是IE6、7、8），需要使用css3-mediaqueries.js。</p>
<p>2、不使用绝对宽度</p>
<p>由于网页会根据屏幕宽度调整布局，所以不能使用绝对宽度的布局，也不能使用具有绝对宽度的元素。这一条非常重要。</p>
<p>具体说，CSS代码不能指定像素宽度：</p>
<p>width:xxxpx;</p>
<p>只能指定百分比宽度：</p>
<p>width:xx%;</p>
<p>或者</p>
<p>width:auto;</p>
<p>3、相对大小的字体</p>
<p>字体也不能使用绝对大小（px），而只能使用相对大小（em）。</p>
<p>body{</p>
<p>font:normal100%Helvetica,Arial,sans-serif;</p>
<p>}</p>
<p>上面的代码指定，字体大小是页面默认大小的100%，即16像素。</p>
<p>h1{</p>
<p>font-size:1.5em;</p>
<p>}</p>
<p>然后，h1的大小是默认大小的1.5倍，即24像素（24/16=1.5）。</p>
<p>small{</p>
<p>font-size:0.875em;</p>
<p>}</p>
<p>small元素的大小是默认大小的0.875倍，即14像素（14/16=0.875）。</p>
<p>4、流动布局（fluidgrid）</p>
<p>“流动布局”的含义是，各个区块的位置都是浮动的，不是固定不变的。</p>
<p>.main{</p>
<p>float:right;</p>
<p>width:70%;</p>
<p>}</p>
<p>.leftBar{</p>
<p>float:left;</p>
<p>width:25%;</p>
<p>}</p>
<p>float的好处是，如果宽度太小，放不下两个元素，后面的元素会自动滚动到前面元素的下方，不会在水平方向overflow（溢出），避免了水平滚动条的出现。</p>
<p>另外，绝对定位（position:absolute）的使用，也要非常小心。</p>
<p>5、选择加载CSS</p>
<p>“自适应网页设计”的核心，就是CSS3引入的MediaQuery模块。</p>
<p>它的意思就是，自动探测屏幕宽度，然后加载相应的CSS文件。</p>
<p>media=”screenand(max-device-width:400px)”</p>
<p>href=”tinyScreen.css”/&gt;</p>
<p>上面的代码意思是，如果屏幕宽度小于400像素（max-device-width:400px），就加载tinyScreen.css文件。</p>
<p>media=”screenand(min-width:400px)and(max-device-width:600px)”</p>
<p>href=”smallScreen.css”/&gt;</p>
<p>如果屏幕宽度在400像素到600像素之间，则加载smallScreen.css文件。</p>
<p>除了用html标签加载CSS文件，还可以在现有CSS文件中加载。</p>
<p>6、CSS的@media规则</p>
<p>同一个CSS文件中，也可以根据不同的屏幕分辨率，选择应用不同的CSS规则。</p>
<p>@mediascreenand(max-device-width:400px){</p>
<p>.column{</p>
<p>float:none;</p>
<p>width:auto;</p>
<p>}</p>
<p>#sidebar{</p>
<p>display:none;</p>
<p>}</p>
<p>}</p>
<p>上面的代码意思是，如果屏幕宽度小于400像素，则column块取消浮动（float:none）、宽度自动调节（width:auto），sidebar块不显示<br>（display:none）。</p>
<p>7、图片的自适应（fluidimage）</p>
<p>除了布局和文本，”自适应网页设计”还必须实现图片的自动缩放。</p>
<p>这只要一行CSS代码：</p>
<p>img{max-width:100%;}</p>
<p>这行代码对于大多数嵌入网页的视频也有效，所以可以写成：</p>
<p>img,object{max-width:100%;}</p>
<p>老版本的IE不支持max-width，所以只好写成：</p>
<p>img{width:100%;}</p>
<p>此外，windows平台缩放图片时，可能出现图像失真现象。这时，可以尝试使用IE的专有命令：</p>
<p>img{-ms-interpolation-mode:bicubic;}</p>
<p>或者，EthanMarcotte的imgSizer.js。</p>
<p>addLoadEvent(function(){</p>
<p>varimgs=document.getElementById(“content”).getElementsByTagName(“img”);</p>
<p>imgSizer.collate(imgs);</p>
<p>});</p>
<p>最好还是做适配分辨率的图片。有很多方法可以做到同样效果，服务器端和客户端都可以实现。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="https://www.itchina.top/2018/04/20/7个步骤让PC网站自动适配手机网页/#comments" id="sourceId::2018/04/20/7个步骤让PC网站自动适配手机网页/" class="article-comment-link cy_cmt_count">评论</a>
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/5/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/">下一页 &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Spring/">Spring</a></p>
                            <p class="item-title"><a href="/2018/04/20/在Docker容器中运行Spring Boot应用/" class="title">在Docker容器中运行Spring Boot应用</a></p>
                            <p class="item-date"><time datetime="2018-04-19T16:34:21.469Z" itemprop="datePublished">2018-04-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/集群/">集群</a></p>
                            <p class="item-title"><a href="/2018/04/20/小白科普：分布式和集群/" class="title">小白科普：分布式和集群</a></p>
                            <p class="item-date"><time datetime="2018-04-19T16:34:21.468Z" itemprop="datePublished">2018-04-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/IDE/">IDE</a></p>
                            <p class="item-title"><a href="/2018/04/20/项目相关的CVS操作/" class="title">项目相关的CVS操作</a></p>
                            <p class="item-date"><time datetime="2018-04-19T16:34:21.467Z" itemprop="datePublished">2018-04-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/J2EE/">J2EE</a></p>
                            <p class="item-title"><a href="/2018/04/20/图片转换PDF文件/" class="title">图片转换PDF文件</a></p>
                            <p class="item-date"><time datetime="2018-04-19T16:34:21.449Z" itemprop="datePublished">2018-04-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2018/04/20/通过Ajax进行POST提交JSON类型的数据到SpringMVC Controller的方法/" class="title">通过Ajax进行POST提交JSON类型的数据到SpringMVC Controller的方法</a></p>
                            <p class="item-date"><time datetime="2018-04-19T16:34:21.448Z" itemprop="datePublished">2018-04-20</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ActiveMQ/">ActiveMQ</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ExtJs/">ExtJs</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IDE/">IDE</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/">J2EE</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/J2EE/Spring/">Spring</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/cnn图片数据处理、显示/">cnn图片数据处理、显示</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/cnn图片数据处理、显示/python数据分析/">python数据分析</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/web前端/">web前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/集群/">集群</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/集群/">集群</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">65</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/">Apache</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Druid/">Druid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ImageToPDF/">ImageToPDF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logstash/">Logstash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/">Spring Boot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activemq/">activemq</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ajax/">ajax</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cas/">cas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exception/">exception</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ext/">ext</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/extjs/">extjs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/find/">find</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ide/">ide</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jboss/">jboss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jmx/">jmx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jpa/">jpa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lombok/">lombok</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvc/">mvc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/numpy/">numpy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/seo/">seo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/">server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shiro/">shiro</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/">spring</a><span class="tag-list-count">17</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-mvc/">spring mvc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boo/">spring-boo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql-server/">sql server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/">windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式日志/">分布式日志</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工作/">工作</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异常/">异常</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异常处理/">异常处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/搜索引擎/">搜索引擎</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据分析/">数据分析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汉字转拼音/">汉字转拼音</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/版本控制系统/">版本控制系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/程序员/">程序员</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/经验/">经验</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集群/">集群</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Apache/" style="font-size: 10px;">Apache</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Druid/" style="font-size: 10px;">Druid</a> <a href="/tags/ImageToPDF/" style="font-size: 10px;">ImageToPDF</a> <a href="/tags/Logstash/" style="font-size: 10px;">Logstash</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/activemq/" style="font-size: 18px;">activemq</a> <a href="/tags/ajax/" style="font-size: 10px;">ajax</a> <a href="/tags/angular/" style="font-size: 10px;">angular</a> <a href="/tags/cas/" style="font-size: 10px;">cas</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/exception/" style="font-size: 10px;">exception</a> <a href="/tags/ext/" style="font-size: 14px;">ext</a> <a href="/tags/extjs/" style="font-size: 14px;">extjs</a> <a href="/tags/find/" style="font-size: 10px;">find</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/ide/" style="font-size: 12px;">ide</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/java/" style="font-size: 16px;">java</a> <a href="/tags/javascript/" style="font-size: 12px;">javascript</a> <a href="/tags/jboss/" style="font-size: 10px;">jboss</a> <a href="/tags/jmx/" style="font-size: 10px;">jmx</a> <a href="/tags/jpa/" style="font-size: 10px;">jpa</a> <a href="/tags/linux/" style="font-size: 14px;">linux</a> <a href="/tags/lombok/" style="font-size: 10px;">lombok</a> <a href="/tags/mvc/" style="font-size: 10px;">mvc</a> <a href="/tags/mybatis/" style="font-size: 10px;">mybatis</a> <a href="/tags/mysql/" style="font-size: 12px;">mysql</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/numpy/" style="font-size: 10px;">numpy</a> <a href="/tags/seo/" style="font-size: 10px;">seo</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/shiro/" style="font-size: 12px;">shiro</a> <a href="/tags/spring/" style="font-size: 20px;">spring</a> <a href="/tags/spring-mvc/" style="font-size: 10px;">spring mvc</a> <a href="/tags/spring-boo/" style="font-size: 10px;">spring-boo</a> <a href="/tags/sql-server/" style="font-size: 10px;">sql server</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/tags/优化/" style="font-size: 12px;">优化</a> <a href="/tags/分布式日志/" style="font-size: 10px;">分布式日志</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/工作/" style="font-size: 10px;">工作</a> <a href="/tags/异常/" style="font-size: 10px;">异常</a> <a href="/tags/异常处理/" style="font-size: 10px;">异常处理</a> <a href="/tags/搜索引擎/" style="font-size: 12px;">搜索引擎</a> <a href="/tags/数据分析/" style="font-size: 10px;">数据分析</a> <a href="/tags/汉字转拼音/" style="font-size: 10px;">汉字转拼音</a> <a href="/tags/版本控制系统/" style="font-size: 10px;">版本控制系统</a> <a href="/tags/程序员/" style="font-size: 10px;">程序员</a> <a href="/tags/经验/" style="font-size: 10px;">经验</a> <a href="/tags/集群/" style="font-size: 10px;">集群</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://www.baidu.com">百度</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy;2018 - &nbsp; 2018 LErry Li &nbsp;版权所有<br>
			<a href="http://www.miitbeian.gov.cn">沪ICP备17054498号-3</a>
        </div>
    </div>
</footer>
        
    
    <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cytxPSIHr"></script>
    <script charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/changyan.js" ></script>
    <script type="text/javascript">
    window.changyan.api.config({
    appid: 'cytxPSIHr',
    conf: 'prod_3c92d05d8ba4377e48c5fe27c2159761'
    });
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>